---
title: "IDRGP 2023"
author: "FPR e DG"
date: "2024-04-05"
output:
  pdf_document: default
  html_document: default
---

# IDRGP 2023

## **Script para o monitoramento do IDRGP no exercício de 2023**

### Intodução

**Objetivo**: levantar, tratar e analisar dados dos valores executados, nas regiões da cidade de são paulo a partir de uma cesta de desepesas selecionadas, que incluem o Programa de Metas 2021-2024 Versão Alteração Programática, uma lista de obras monitoradas e intervenções do Orçamento Cidadão

### Pacotes utilizados:

```{r Pacotes, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

library(tidyverse)
library(readxl)
library(sf)
library(tinytex)
library(janitor)


base::options(scipen = 99)

```

### Valores de referência do IDRGP

Inicialmente, inserimos os valores de referência do IDRGP:

```{r Valores de referência, echo=FALSE, message=FALSE, warning=FALSE}
(ref_idrgp <- dplyr::tibble(sp_nome = c("Subprefeitura Capela do Socorro",
                                        "Subprefeitura M'Boi Mirim",
                                        "Subprefeitura Campo Limpo",
                                        "Subprefeitura São Mateus",
                                        "Subprefeitura Itaquera",
                                        "Subprefeitura Cidade Ademar",
                                        "Subprefeitura Freguesia/Brasilândia",
                                        "Subprefeitura São Miguel Paulista",
                                        "Subprefeitura Itaim Paulista",
                                        "Subprefeitura Pirituba/Jaraguá",
                                        "Subprefeitura Parelheiros",
                                        "Subprefeitura Jaçanã/Tremembé",
                                        "Subprefeitura Sapopemba",
                                        "Subprefeitura de Guaianases",
                                        "Subprefeitura Penha",
                                        "Subprefeitura Ipiranga",
                                        "Subprefeitura Cidade Tiradentes",
                                        "Subprefeitura Casa Verde/Cachoeirinha",
                                        "Subprefeitura Perus/Anhanguera",
                                        "Subprefeitura Butantã",
                                        "Subprefeitura Ermelino Matarazzo",
                                        "Subprefeitura de Vila Prudente",
                                        "Subprefeitura Sé",
                                        "Subprefeitura Vila Maria/Vila Guilherme",
                                        "Subprefeitura Aricanduva/Formosa/Carrão",
                                        "Subprefeitura Jabaquara",
                                        "Subprefeitura Mooca",
                                        "Subprefeitura Santana/Tucuruvi",
                                        "Subprefeitura Lapa",
                                        "Subprefeitura Santo Amaro",
                                        "Subprefeitura Vila Mariana",
                                        "Subprefeitura Pinheiros"),
  ref_idrgp = c(0.0708, 0.0706, 0.0616, 0.0511, 0.0487, 0.0483, 0.0456, 0.0419,
                0.0406, 0.0377, 0.0374, 0.0364, 0.0353, 0.0346, 0.0346, 0.0291,
                0.0278, 0.0270, 0.0258, 0.0250, 0.0210, 0.0183, 0.0179, 0.0167,
                0.0157, 0.0150, 0.0150, 0.0146, 0.0113, 0.0094, 0.0086, 0.0068)) %>% 
  arrange(desc(ref_idrgp)))
```

### Base cartográfica do Município

Em seguida, inserimos a base cartográfica do município de São Paulo obtida a partir do GeoSampa.

A partir dela, selecionamos os dados das Subprefeituras com os valores de referência do índice.

```{r Cartografia, echo=FALSE, message=FALSE, warning=FALSE}
sp <- read_sf("SIRGAS_SHP_subprefeitura//SIRGAS_SHP_subprefeitura_polygon.shp")

subprefeitura <- sp %>% 
    rename(sigla = sp_sigla,
           NOME=sp_nome) %>% 
    select(NOME, sigla, geometry)
subprefeitura<- subprefeitura %>% 
  mutate(sp_nome = case_when(
    sigla %in% "AF" ~ "Subprefeitura Aricanduva/Formosa/Carrão",
    sigla %in% "BT" ~ "Subprefeitura Butantã",
    sigla %in% "CL" ~ "Subprefeitura Campo Limpo",
    sigla %in% "CS" ~ "Subprefeitura Capela do Socorro",
    sigla %in% "CV" ~ "Subprefeitura Casa Verde/Cachoeirinha",
    sigla %in% "CAA" ~ "Subprefeitura Cidade Ademar",
    sigla %in% "CT" ~ "Subprefeitura Cidade Tiradentes",
    sigla %in% "EM" ~ "Subprefeitura Ermelino Matarazzo",
    sigla %in% "FO" ~ "Subprefeitura Freguesia/Brasilândia",
    sigla %in% "GU" ~ "Subprefeitura de Guaianases",
    sigla %in% "IP" ~ "Subprefeitura Ipiranga",
    sigla %in% "IP" ~ "Subprefeitura Itaim Paulista",
    sigla %in% "IT" ~ "Subprefeitura Itaquera",
    sigla %in% "JA" ~ "Subprefeitura Jabaquara",
    sigla %in% "JT" ~ "Subprefeitura Jaçanã/Tremembé",
    sigla %in% "LA" ~ "Subprefeitura Lapa",
    sigla %in% "MB" ~ "Subprefeitura M'Boi Mirim",
    sigla %in% "MO" ~ "Subprefeitura Mooca",
    sigla %in% "PA" ~ "Subprefeitura Parelheiros",
    sigla %in% "PE" ~ "Subprefeitura Penha",
    sigla %in% "PR" ~ "Subprefeitura Perus/Anhanguera",
    sigla %in% "PI" ~ "Subprefeitura Pinheiros",
    sigla %in% "PJ" ~ "Subprefeitura Pirituba/Jaraguá",
    sigla %in% "ST" ~ "Subprefeitura Santana/Tucuruvi",
    sigla %in% "SA" ~ "Subprefeitura Santo Amaro",
    sigla %in% "SM" ~ "Subprefeitura São Mateus",
    sigla %in% "MP" ~ "Subprefeitura São Miguel Paulista",
    sigla %in% "SB" ~ "Subprefeitura Sapopemba",
    sigla %in% "SE" ~ "Subprefeitura Sé",
    sigla %in% "MG" ~ "Subprefeitura Vila Maria/Vila Guilherme",
    sigla %in% "VM" ~ "Subprefeitura Vila Mariana",
    TRUE ~ "Subprefeitura de Vila Prudente"))

subprefeitura <- inner_join(subprefeitura, ref_idrgp, by = "sp_nome")
#teste do mapa com siglas
subprefeitura %>% 
  ggplot() +
  geom_sf(aes(fill = ref_idrgp, geometry = geometry)) +
  scale_fill_gradient(low="red",high="blue") +
  geom_sf_text(aes(label = sigla), color = "black", size = 1.5, fontface = "bold") + 
  theme_void()

```

### Bases do PdM 2021-2024

Nesta seção, detalhamos os processos de obtenção e transformação dos dados de execução física e orçamentária do Programa de Metas. Para efeitos de monitoramento do IDRGP 2023, são considerados 29 compromissos do Programa de Metas 2021-2024 versão Alteração Programática. Tanto os dados de execução física quanto os da execução orçamentária são inseridos por cada órgão responsável no Sistema de Monitoramento e Acompanhamento Estratégico (SMAE).

Os dados de execução física são, nas metas selecionadas para o IDRGP 2023, desagregadas em nível regional (subprefeitura), podendo, dessa forma, serem extraídos diretamente do SMAE. Um relatório foi extraído em 04/03/2024 e registrado na aba "execucao_regionalizada, do documento"metas_alteracao_programatica.xlsx". Os dados de execução orçamentária correspondem à liquidação das dotações orçamentárias que abarcam despesas vinculadas ao Programa de Metas. Para a desagregação regional destes dados, lançou-se mão de duas estratégias:

-   Coleta de dados diretamente com os órgãos, nos casos das Metas 3, 4, 5, 7, 8, 9, 78 e 79, sob responsabilidade da Secretaria Municpal de Saúde (SMS) e da Meta 58, conduzida pela Secretaria Municipal de Cultura (SMC);
- Cálculo da razão entre o valor liquidado e a execução física, por região, para a Meta 17;
-   Regionalização a partir do "Detalhamento da Ação", por meio de consulta a dados publicados pela Secretaria da Fazenda (SF). A base de dados da regionalização da execução orçamentária do exercício de 2023, pode ser extraída por meio do portal: \<[[https://orcamento.sf.prefeitura.sp.gov.br/orcamente/execucao.php\\\\](https://orcamento.sf.prefeitura.sp.gov.br/orcamente/execucao.php\\){.uri}]([https://orcamento.sf.prefeitura.sp.gov.br/orcamente/execucao.php\\](https://orcamento.sf.prefeitura.sp.gov.br/orcamente/execucao.php\){.uri}){.uri}\>, nos formatos "[.csv](https://orcamento.sf.prefeitura.sp.gov.br/orcamento/uploads/2023/basedadosDA_1223.csv)", "[.xlsx](https://orcamento.sf.prefeitura.sp.gov.br/orcamento/uploads/2023/basedadosDA_1223.xlsx)", "[.ods](https://orcamento.sf.prefeitura.sp.gov.br/orcamento/uploads/2023/basedadosDA_1223.ods)" ou "[.json](https://orcamento.sf.prefeitura.sp.gov.br/orcamento/uploads/2023/basedadosDA_1223.json)"

Para regionalização da execução orçamentária das metas consideradas para o monitoramento do IDRGP 2023, utilizamos a base no formato ".xlsx". Manipulamos a planilha de forma que cada linha correspondesse a uma dotação orçamentária e, em colunas, obtivessemos valor correspondente para cada uma das subprefeituras (ou outros níveis de regionalização).

Há casos em que a execução orçamentária da dotação foi integralmente dedicada ao Programa de Metas. Nesses casos, o valor regionalizado pelo detalhamento da ação corresponde ao valor regionalizado das metas consideradas para o IDRGP 2023.

Nos casos em que a dotação orçamentária não abarcou desepesas exclusivas do Programa de Metas, assumiu-se que a execução regionalizada da meta foi proporcional à regioanlização pelo detalhamento da ação. Esta planilha manipulada foi registrada na aba "totais_meta", do documento "metas_alteracao_programatica.xlsx".

Para que não houvesse perda de dados ao inserir as informações fornecidas diretamente por SMS e SMS, o documento "metas_alteracao_programatica.xlsx" abarca uma aba contendo a mesma base da aba "totais_metas", substituindo as linhas correspondentes às metas 3, 4, 5, 7, 8, 9, 58, 78 e 79 pelos valores informados pelos órgõas. Esta base encontra-se na aba "totais_metas_inf_orgaos".

Introduzidas as passagens que originaram os dados da execução física e orçamentária do Programa de Metas, apresentamos, a seguir, as manipulações necessárias para a análise dos dados.

```{r}
#ler a aba totais_metas
df_pdm1 <- readxl::read_excel("metas_alteracao_programatica.xlsx", sheet = "totais_metas", skip = 266) %>% 
   dplyr::select(-c("Diferença Soma dos valores proporcionais vs SMAE",
                    "Observações",
                    "...46",
                    "supra",
                    "...48",
                    "zero"))

#transformar as colunas de subprefeituras e supra subprefeituras em uma única coluna
df_pdm1 <- df_pdm1 %>% 
    tidyr::pivot_longer(
      cols = c("Subprefeitura Aricanduva/Formosa/Carrão":"SE+SUPRACENTRO"),
      names_to = "sp_nome",
      values_to = "valor_da")


#ler a aba totais_metas_inf_orgaos
df_pdm2 <- readxl::read_excel("metas_alteracao_programatica.xlsx", sheet = "totais_metas_inf_orgaos", skip = 266) %>% 
    dplyr::select(-c("Diferença Soma dos valores proporcionais vs SMAE", "Observações")) %>% 
    dplyr::rename("SE+SUPRACENTRO" = "SE+SUPRA_CENTRO") #para padronizar os nomes dessas colunas

#transformar as colunas de subprefeituras e supra subprefeituras em uma única coluna
df_pdm2 <- df_pdm2 %>% 
    tidyr::pivot_longer(
      cols = c("Subprefeitura Aricanduva/Formosa/Carrão":"SE+SUPRACENTRO"),
      names_to = "sp_nome",
      values_to = "valor_da_inf_orgao") %>% 
    dplyr::select(META, DOTACAO, sp_nome, valor_da_inf_orgao)


## juntar df_pdm1 e df_pdm2
(df_pdm <- dplyr::full_join(df_pdm1, df_pdm2, by = c("META", "DOTACAO", "sp_nome")))

df_pdm$valor_da_inf_orgao <- df_pdm$valor_da_inf_orgao %>% tidyr::replace_na(0) #substituir NA por 0


# checar valores
base::sum(df_pdm$valor_da, na.rm = TRUE)-base::sum(df_pdm1$valor_da, na.rm = TRUE)
base::sum(df_pdm$valor_da_inf_orgao, na.rm = TRUE)-base::sum(df_pdm2$valor_da_inf_orgao, na.rm = TRUE)

```
Ao consolidar a base de dados do Programa de Metas, identificou-se alguma movimentação equivocada que acrescentou R$ 55.488.642 tanto na coluna valor_da quanto na coluna valor_da_inf_orgao. O bloco, a seguir, busca explorar e sanear o problema.

```{r paged.print=TRUE}

#obter informações do DA
base_da <- readr::read_csv2("https://orcamento.sf.prefeitura.sp.gov.br/orcamento/uploads/2023/basedadosDA_1223.csv",
                          locale = locale(encoding = "latin1")) %>% 
  janitor::clean_names()

base::names(base_da)


#criar coluna com a codificação da dotação orçamentária

base_da1 <- base_da %>% 
  dplyr::mutate(dotacao = base::paste(codigo_orgao,
                                      codigo_unidade,
                                      codigo_funcao,
                                      codigo_subfuncao,
                                      codigo_programa,
                                      codigo_proj_ativ,
                                      codigo_conta_despesa,
                                      codigo_fonte,
                                      codigo_exercicio_fonte,
                                      codigo_destinacao_recurso,
                                      codigo_vinculo_pmsp,
                                      codigo_tipo_credito_orcamentario,
                                      sep = "."),
                dotacao = base::sub('^(.{19})', '\\1.', dotacao)) %>% 
  dplyr::select(dotacao, sigla_orgao, regiao, subprefeitura, distrito, tipo_regionalizacao, valor_detalhamento_acao) %>% 
  dplyr::group_by(dotacao, subprefeitura) %>% 
  dplyr::summarise(sigla_orgao = first(sigla_orgao),
                   regiao = first(regiao),
                   subprefeitura = first(subprefeitura),
                   distrito = first(distrito),
                   tipo_regionalizacao = first(tipo_regionalizacao),
                   valor_detalhamento_acao = sum(valor_detalhamento_acao)) %>% 
  dplyr::filter(tipo_regionalizacao == "Despesa Regionalizável")


#checar existência de NA

base_da1 %>%
  summarise_all(~ any(is.na(.))) #não há NA

#transformar subprefeitura=="Supra Subprefeitura Centro" em "Subprefeitura Sé"

base_da1 <- base_da1 %>% 
  mutate(subprefeitura = case_when(
    subprefeitura %in% "Supra Subprefeitura Centro" ~ "Subprefeitura Sé",
    TRUE ~ subprefeitura)
  )
  
##Ratear valores de subprefeitura=="Supra Subprefeitura Região X" nas respectivas subprefeituras da Região X

suporte_rateio_regioes <- base_da1 %>% 
  filter(subprefeitura %in% c("Supra Subprefeitura Leste",
                          "Supra Subprefeitura Norte",
                          "Supra Subprefeitura Oeste",
                          "Supra Subprefeitura Sul"))

sum(suporte_rateio_regioes$valor_detalhamento_acao)

n_sub_regioes <- base_da1 %>% 
  filter(!str_detect(subprefeitura, "Supra")) %>% 
  group_by(regiao) %>% 
  summarise(count = n_distinct(subprefeitura))

(suporte_rateio_regioes <- suporte_rateio_regioes %>% 
  left_join(n_sub_regioes, by = "regiao") %>% 
  mutate(valor_rateio = valor_detalhamento_acao / count))

sum(suporte_rateio_regioes$valor_rateio)

(suporte_rateio_regioes <- suporte_rateio_regioes %>% 
    select(-subprefeitura, -distrito, -valor_detalhamento_acao))

(teste <- base_da1 %>%
    left_join(suporte_rateio_regioes, by = c("dotacao", "sigla_orgao", "regiao", "tipo_regionalizacao")))

sum(teste$valor_rateio, na.rm = TRUE)

## Observou-se que teste$valor_rateio e suporte_rateio_regioes$valor_detalhamento_acao possuem valores diferentes.
## Isso ocorre, pois uma série de dotações são supra regionais. É necessário, então, complementar a base_da1, com todas
## as subprefeituras para todas as dotações, para diluir os valores supra regionais nas respectivas subprefeiutras
## de cada região


comp_sub_dot <- expand_grid(dotacao = unique(base_da1$dotacao),
                 subprefeitura = unique(base_da1$subprefeitura))

(a <- base_da1 %>% 
    full_join(comp_sub_dot, by = c("dotacao", "subprefeitura")) %>% 
    arrange(dotacao))

(b <- base_da1 %>% 
    group_by(dotacao) %>% 
    select(-subprefeitura, -regiao, -valor_detalhamento_acao))

(a <- a %>% 
  left_join(b, by = "dotacao"))

(base_da2 <- a %>% 
  mutate(sigla_orgao = if_else(is.na(sigla_orgao.x), sigla_orgao.y, sigla_orgao.x),
         regiao = case_when(
    subprefeitura %in% c("Subprefeitura Aricanduva/Formosa/Carrão",
                   "Subprefeitura Cidade Tiradentes",
                   "Subprefeitura de Guaianases",
                   "Subprefeitura de Vila Prudente",
                   "Subprefeitura Ermelino Matarazzo",
                   "Subprefeitura Itaim Paulista",
                   "Subprefeitura Itaquera",
                   "Subprefeitura Mooca",
                   "Subprefeitura Penha",
                   "Subprefeitura São Mateus",
                   "Subprefeitura São Miguel Paulista",
                   "Subprefeitura Sapopemba",
                   "Supra Subprefeitura Leste") ~ "Leste",
    subprefeitura %in% c("Subprefeitura Butantã",
                   "Subprefeitura Lapa",
                   "Subprefeitura Pinheiros",
                   "Supra Subprefeitura Oeste") ~ "Oeste",
    subprefeitura %in% c("Subprefeitura Casa Verde/Cachoeirinha",
                   "Subprefeitura Freguesia/Brasilândia",
                   "Subprefeitura Jaçanã/Tremembé",
                   "Subprefeitura Perus/Anhanguera",
                   "Subprefeitura Pirituba/Jaraguá",
                   "Subprefeitura Santana/Tucuruvi",
                   "Subprefeitura Vila Maria/Vila Guilherme",
                   "Supra Subprefeitura Norte") ~ "Norte",
    subprefeitura %in% c("Subprefeitura Sé",
                   "Supra Subprefeitura Centro") ~ "Centro",
    TRUE ~ "Sul"),
         distrito = if_else(is.na(distrito.x), distrito.y, distrito.x),
         tipo_regionalizacao = if_else(is.na(tipo_regionalizacao.x), tipo_regionalizacao.y, tipo_regionalizacao.x)) %>% 
    select(-sigla_orgao.x, -distrito.x, -tipo_regionalizacao.x, -sigla_orgao.y, -distrito.y, -tipo_regionalizacao.y,
           dotacao, sigla_orgao, subprefeitura, regiao, distrito, tipo_regionalizacao, valor_detalhamento_acao))


(teste2 <- base_da2 %>%
    left_join(suporte_rateio_regioes, by = c("dotacao", "sigla_orgao", "regiao", "tipo_regionalizacao")))


filter(!subprefeitura %in% c("Supra Subprefeitura Leste",
                          "Supra Subprefeitura Norte",
                          "Supra Subprefeitura Oeste",
                          "Supra Subprefeitura Sul")))

glimpse(suporte_rateio_regioes)
glimpse(base_da1)

  


#acrescentar o gasto proporcial em cada região; em cada dotação

base_da1 <- base_da1 %>% 
  group_by(dotacao) %>% 
  mutate(total_valor = sum(valor_detalhamento_acao))

base_da1 <- base_da1 %>% 
  mutate(proporcao = valor_detalhamento_acao/total_valor)


# criar df a partir de base_da, apenas com as dotações do PdM

nchar("84.10.10.301.3003.1.525.44905100.00.1.500.9001.1") #=48
nchar("25.10.13.392.3001.6.371.3390") #=28

base_dotacao_pdm <- unique(df_pdm$DOTACAO) #string com as dotações pdm

base_da_pdm <- base_da1 %>%
  mutate(dotacao_pdm = case_when(
    dotacao %in% base_dotacao_pdm ~ "s",
    substr(dotacao, 1, 28) %in% substr(base_dotacao_pdm, 1, 28) ~ "s",
    TRUE ~ "n"
  )) %>% 
  filter(dotacao_pdm == "s")

#checar se todas as dotações somam 100%
base_da_pdm %>% 
  group_by(dotacao) %>% 
  summarise(checagem = sum(proporcao))




```




```{r}

df_pdm %>% 
  group_by(META) %>% 
  summarise(sum(unique(valor_da)))

```

