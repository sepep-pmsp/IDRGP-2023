---
title: "IDRGP 2023"
author: "FPR e DG"
date: "2024-04-05"
output: html_document
---

# IDRGP 2023

## **Script para o monitoramento do IDRGP no exercício de 2023**

### Intodução

**Objetivo**: levantar, tratar e analisar dados dos valores executados, nas regiões da cidade de são paulo a partir de uma cesta de desepesas selecionadas, que incluem o Programa de Metas 2021-2024 Versão Alteração Programática, uma lista de obras monitoradas e intervenções do Orçamento Cidadão

### Pacotes utilizados:

```{r Pacotes, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

library(tidyverse)
library(readxl)
library(purrr)
library(sf)

base::options(scipen = 99)

```

### Valores de referência do IDRGP

Inicialmente inserimos os valores de referência do IDRGP:

```{r Valores de referência, echo=FALSE, message=FALSE, warning=FALSE}
(ref_idrgp <- dplyr::tibble(sp_nome = c("Subprefeitura Capela do Socorro",
                                        "Subprefeitura M'Boi Mirim",
                                        "Subprefeitura Campo Limpo",
                                        "Subprefeitura São Mateus",
                                        "Subprefeitura Itaquera",
                                        "Subprefeitura Cidade Ademar",
                                        "Subprefeitura Freguesia/Brasilândia",
                                        "Subprefeitura São Miguel Paulista",
                                        "Subprefeitura Itaim Paulista",
                                        "Subprefeitura Pirituba/Jaraguá",
                                        "Subprefeitura Parelheiros",
                                        "Subprefeitura Jaçanã/Tremembé",
                                        "Subprefeitura Sapopemba",
                                        "Subprefeitura de Guaianases",
                                        "Subprefeitura Penha",
                                        "Subprefeitura Ipiranga",
                                        "Subprefeitura Cidade Tiradentes",
                                        "Subprefeitura Casa Verde/Cachoeirinha",
                                        "Subprefeitura Perus/Anhanguera",
                                        "Subprefeitura Butantã",
                                        "Subprefeitura Ermelino Matarazzo",
                                        "Subprefeitura de Vila Prudente",
                                        "Subprefeitura Sé",
                                        "Subprefeitura Vila Maria/Vila Guilherme",
                                        "Subprefeitura Aricanduva/Formosa/Carrão",
                                        "Subprefeitura Jabaquara",
                                        "Subprefeitura Mooca",
                                        "Subprefeitura Santana/Tucuruvi",
                                        "Subprefeitura Lapa",
                                        "Subprefeitura Santo Amaro",
                                        "Subprefeitura Vila Mariana",
                                        "Subprefeitura Pinheiros"),
  ref_idrgp = c(0.0708, 0.0706, 0.0616, 0.0511, 0.0487, 0.0483, 0.0456, 0.0419,
                0.0406, 0.0377, 0.0374, 0.0364, 0.0353, 0.0346, 0.0346, 0.0291,
                0.0278, 0.0270, 0.0258, 0.0250, 0.0210, 0.0183, 0.0179, 0.0167,
                0.0157, 0.0150, 0.0150, 0.0146, 0.0113, 0.0094, 0.0086, 0.0068)) %>% 
  arrange(desc(ref_idrgp)))
```

### Base cartográfica do Município

Em seguida, inserimos a base cartográfica do município de São Paulo obtida a partir do GeoSampa.

A partir dela selecionamos os dados das Subprefeituras com os valores de referência do índice.

```{r Cartografia, echo=FALSE, message=FALSE, warning=FALSE}
sp <- read_sf("SIRGAS_SHP_subprefeitura//SIRGAS_SHP_subprefeitura_polygon.shp")

subprefeitura <- sp %>% 
    rename(sigla = sp_sigla,
           NOME=sp_nome) %>% 
    select(NOME, sigla, geometry)
subprefeitura<- subprefeitura %>% 
   mutate(sp_nome = case_when(
    sigla %in% "AF" ~ "Subprefeitura Aricanduva/Formosa/Carrão",
    sigla %in% "BT" ~ "Subprefeitura Butantã",
    sigla %in% "CL" ~ "Subprefeitura Campo Limpo",
    sigla %in% "CS" ~ "Subprefeitura Capela do Socorro",
    sigla %in% "CV" ~ "Subprefeitura Casa Verde/Cachoeirinha",
    sigla %in% "AD" ~ "Subprefeitura Cidade Ademar",
    sigla %in% "CT" ~ "Subprefeitura Cidade Tiradentes",
    sigla %in% "EM" ~ "Subprefeitura Ermelino Matarazzo",
    sigla %in% "FO" ~ "Subprefeitura Freguesia/Brasilândia",
    sigla %in% "GU" ~ "Subprefeitura de Guaianases",
    sigla %in% "IP" ~ "Subprefeitura Ipiranga",
    sigla %in% "IT" ~ "Subprefeitura Itaim Paulista",
    sigla %in% "IQ" ~ "Subprefeitura Itaquera",
    sigla %in% "JA" ~ "Subprefeitura Jabaquara",
    sigla %in% "JT" ~ "Subprefeitura Jaçanã/Tremembé",
    sigla %in% "LA" ~ "Subprefeitura Lapa",
    sigla %in% "MB" ~ "Subprefeitura M'Boi Mirim",
    sigla %in% "MO" ~ "Subprefeitura Mooca",
    sigla %in% "PA" ~ "Subprefeitura Parelheiros",
    sigla %in% "PE" ~ "Subprefeitura Penha",
    sigla %in% "PR" ~ "Subprefeitura Perus/Anhanguera",
    sigla %in% "PI" ~ "Subprefeitura Pinheiros",
    sigla %in% "PJ" ~ "Subprefeitura Pirituba/Jaraguá",
    sigla %in% "ST" ~ "Subprefeitura Santana/Tucuruvi",
    sigla %in% "SA" ~ "Subprefeitura Santo Amaro",
    sigla %in% "SM" ~ "Subprefeitura São Mateus",
    sigla %in% "MP" ~ "Subprefeitura São Miguel Paulista",
    sigla %in% "SB" ~ "Subprefeitura Sapopemba",
    sigla %in% "SE" ~ "Subprefeitura Sé",
    sigla %in% "MG" ~ "Subprefeitura Vila Maria/Vila Guilherme",
    sigla %in% "VM" ~ "Subprefeitura Vila Mariana",
    TRUE ~ "Subprefeitura de Vila Prudente"))

subprefeitura <- inner_join(subprefeitura, ref_idrgp, by = "sp_nome")
#teste do mapa com siglas
subprefeitura %>% 
  ggplot() +
  geom_sf(aes(fill = ref_idrgp, geometry = geometry)) +
  scale_fill_gradient(low="red",high="blue") +
  geom_sf_text(aes(label = sigla), color = "black", size = 1.5, fontface = "bold") + 
  theme_void()

```

### Adicionando a base de Obras Prioritárias

Para gerar a base de Obras Priotirárias, iremos abrir a base encaminhada pela Unidade de Entregas da SEPEP, padronizar nomes e realizar filtros, como os que removem obras de mobilidade e macrodrenagem, bem como "Requalificação", "Restauro" e "Manutenção" com valores inferiores a um milhão de reais, pois estas obras não compõem o cálculo do IDRGP.

```{r Limpando a base de obras prioritárias, message=FALSE, warning=FALSE, include=FALSE}
op <- read_xlsx("base_monitoramento_obras.xlsx")
op <- op %>% 
  filter(`Meta PdM`== "Não", valor_liquidado_total>0)

op <- op %>% 
  mutate(analise = ifelse(`Tipo de obra/intervenção`== "Requalificação", "analisar", NA ),
         analise = ifelse(`Tipo de obra/intervenção`== "Restauro", "analisar", analise),
         analise = ifelse(`Tipo de obra/intervenção`== "Manutenção", "analisar", analise),
         analise = ifelse(`Tipo de obra/intervenção`== "Requalificação ", "analisar", analise ))
op <- op %>% 
  mutate(decisão1 = ifelse(`Tipo de obra/intervenção`== "Requalificação" & valor_liquidado_total<1000000, "excluir", "manter"))
op <- op %>% 
  mutate(decisão2 = ifelse(`Tipo de obra/intervenção`== "Restauro" & valor_liquidado_total<1000000, "excluir", "manter"))
op <- op %>% 
  mutate(decisão3 = ifelse(`Tipo de obra/intervenção`== "Manutenção" & valor_liquidado_total<1000000, "excluir", "manter"))
op <- op %>% 
  mutate(decisão4 = ifelse(`Tipo de obra/intervenção`== "Requalificação " & valor_liquidado_total<1000000, "excluir", "manter"))
op <- op %>%
  filter(decisão1=="manter" & decisão2=="manter" & decisão3== "manter" & decisão4=="manter")

op<- op %>% 
  mutate(macrod1 = str_detect(`Obra/Intervenção`, "Córrego", FALSE))
op<- op %>% 
  mutate(macrod2 = str_detect(`Obra/Intervenção`, "Piscinão", F))
op<- op %>% 
  mutate(macrod3 = str_detect(`Obra/Intervenção`, "Reservatório", F))
op<- op %>% 
  mutate(macrod4 = str_detect(`Obra/Intervenção`, "Canalização", F))
op <- op %>%
  filter(macrod1==F & macrod2== F & macrod3== F & macrod4== F)

op <- op %>% 
  mutate(Subprefeitura = ifelse(Subprefeitura == "Aricanduva/Carrão/Formosa", "Aricanduva/Formosa/Carrão", Subprefeitura))
op <- op %>% 
  filter(Secretaria != "SMT") %>% 
  mutate(DOTACAO = NA) %>%
  select("...1", DOTACAO,  Secretaria, Subprefeitura, valor_liquidado_total)

op<- op %>% 
   mutate("sp_nome" = case_when(
    Subprefeitura %in% "Aricanduva/Formosa/Carrão" ~ "Subprefeitura Aricanduva/Formosa/Carrão",
    Subprefeitura %in% "Butantã" ~ "Subprefeitura Butantã",
    Subprefeitura %in% "Campo Limpo" ~ "Subprefeitura Campo Limpo",
    Subprefeitura %in% "Capela do Socorro" ~ "Subprefeitura Capela do Socorro",
    Subprefeitura %in% "Casa Verde/Cachoeirinha" ~ "Subprefeitura Casa Verde/Cachoeirinha",
    Subprefeitura %in% "Cidade Ademar" ~ "Subprefeitura Cidade Ademar",
    Subprefeitura %in% "Cidade Tiradentes" ~ "Subprefeitura Cidade Tiradentes",
    Subprefeitura %in% "Ermelino Matarazzo" ~ "Subprefeitura Ermelino Matarazzo",
    Subprefeitura %in% "Freguesia do Ó/Brasilândia" ~ "Subprefeitura Freguesia/Brasilândia",
    Subprefeitura %in% "Guaianases" ~ "Subprefeitura de Guaianases",
    Subprefeitura %in% "Ipiranga" ~ "Subprefeitura Ipiranga",
    Subprefeitura %in% "Itaim Paulista" ~ "Subprefeitura Itaim Paulista",
    Subprefeitura %in% "Itaquera" ~ "Subprefeitura Itaquera",
    Subprefeitura %in% "Jabaquara" ~ "Subprefeitura Jabaquara",
    Subprefeitura %in% "Jaçanã/Tremembé" ~ "Subprefeitura Jaçanã/Tremembé",
    Subprefeitura %in% "Lapa" ~ "Subprefeitura Lapa",
    Subprefeitura %in% "M'Boi Mirim" ~ "Subprefeitura M'Boi Mirim",
    Subprefeitura %in% "Mooca" ~ "Subprefeitura Mooca",
    Subprefeitura %in% "Parelheiros" ~ "Subprefeitura Parelheiros",
    Subprefeitura %in% "Penha" ~ "Subprefeitura Penha",
    Subprefeitura %in% "Perus" ~ "Subprefeitura Perus/Anhanguera",
    Subprefeitura %in% "Pinheiros" ~ "Subprefeitura Pinheiros",
    Subprefeitura %in% "Pirituba/Jaraguá" ~ "Subprefeitura Pirituba/Jaraguá",
    Subprefeitura %in% "Santana/Tucuruvi" ~ "Subprefeitura Santana/Tucuruvi",
    Subprefeitura %in% "Santo Amaro" ~ "Subprefeitura Santo Amaro",
    Subprefeitura %in% "São Mateus" ~ "Subprefeitura São Mateus",
    Subprefeitura %in% "São Miguel Paulista" ~ "Subprefeitura São Miguel Paulista",
    Subprefeitura %in% "Sapopemba" ~ "Subprefeitura Sapopemba",
    Subprefeitura %in% "Sé" ~ "Subprefeitura Sé",
    Subprefeitura %in% "Vila Maria/Vila Guilherme" ~ "Subprefeitura Vila Maria/Vila Guilherme",
    Subprefeitura %in% "Vila Mariana" ~ "Subprefeitura Vila Mariana",
    TRUE ~ "Subprefeitura de Vila Prudente"))


```

Então, descobrimos o valor total empenhado e agregamos as observações por Subprefeitura para realizar as análises

```{r Obras Prioritárias por Subprefeitura, echo=FALSE}

sum(op$valor_liquidado_total)
obras_prioritarias <- op %>%
  group_by(Subprefeitura) %>% 
  summarise(total_op = sum(valor_liquidado_total))

obras_prioritarias<- obras_prioritarias %>% 
   mutate("sp_nome" = case_when(
    Subprefeitura %in% "Aricanduva/Formosa/Carrão" ~ "Subprefeitura Aricanduva/Formosa/Carrão",
    Subprefeitura %in% "Butantã" ~ "Subprefeitura Butantã",
    Subprefeitura %in% "Campo Limpo" ~ "Subprefeitura Campo Limpo",
    Subprefeitura %in% "Capela do Socorro" ~ "Subprefeitura Capela do Socorro",
    Subprefeitura %in% "Casa Verde/Cachoeirinha" ~ "Subprefeitura Casa Verde/Cachoeirinha",
    Subprefeitura %in% "Cidade Ademar" ~ "Subprefeitura Cidade Ademar",
    Subprefeitura %in% "Cidade Tiradentes" ~ "Subprefeitura Cidade Tiradentes",
    Subprefeitura %in% "Ermelino Matarazzo" ~ "Subprefeitura Ermelino Matarazzo",
    Subprefeitura %in% "Freguesia do Ó/Brasilândia" ~ "Subprefeitura Freguesia/Brasilândia",
    Subprefeitura %in% "Guaianases" ~ "Subprefeitura de Guaianases",
    Subprefeitura %in% "Ipiranga" ~ "Subprefeitura Ipiranga",
    Subprefeitura %in% "Itaim Paulista" ~ "Subprefeitura Itaim Paulista",
    Subprefeitura %in% "Itaquera" ~ "Subprefeitura Itaquera",
    Subprefeitura %in% "Jabaquara" ~ "Subprefeitura Jabaquara",
    Subprefeitura %in% "Jaçanã/Tremembé" ~ "Subprefeitura Jaçanã/Tremembé",
    Subprefeitura %in% "Lapa" ~ "Subprefeitura Lapa",
    Subprefeitura %in% "M'Boi Mirim" ~ "Subprefeitura M'Boi Mirim",
    Subprefeitura %in% "Mooca" ~ "Subprefeitura Mooca",
    Subprefeitura %in% "Parelheiros" ~ "Subprefeitura Parelheiros",
    Subprefeitura %in% "Penha" ~ "Subprefeitura Penha",
    Subprefeitura %in% "Perus" ~ "Subprefeitura Perus/Anhanguera",
    Subprefeitura %in% "Pinheiros" ~ "Subprefeitura Pinheiros",
    Subprefeitura %in% "Pirituba/Jaraguá" ~ "Subprefeitura Pirituba/Jaraguá",
    Subprefeitura %in% "Santana/Tucuruvi" ~ "Subprefeitura Santana/Tucuruvi",
    Subprefeitura %in% "Santo Amaro" ~ "Subprefeitura Santo Amaro",
    Subprefeitura %in% "São Mateus" ~ "Subprefeitura São Mateus",
    Subprefeitura %in% "São Miguel Paulista" ~ "Subprefeitura São Miguel Paulista",
    Subprefeitura %in% "Sapopemba" ~ "Subprefeitura Sapopemba",
    Subprefeitura %in% "Sé" ~ "Subprefeitura Sé",
    Subprefeitura %in% "Vila Maria/Vila Guilherme" ~ "Subprefeitura Vila Maria/Vila Guilherme",
    Subprefeitura %in% "Vila Mariana" ~ "Subprefeitura Vila Mariana",
    TRUE ~ "Subprefeitura de Vila Prudente"))

```

Em seguida, conectamos com a base catográfica para georreferenciar os dados

```{r Obras Prioritárias regionalizado, echo=FALSE}
idrgp_op<- full_join(subprefeitura, obras_prioritarias, by = "sp_nome")

idrgp_op %>% 
  ggplot() +
  geom_sf(aes(fill = total_op, geometry = geometry)) +
  scale_fill_gradient(low="white",high="blue") +
  geom_sf_text(aes(label = sigla), color = "black", size = 1.5, fontface = "bold") + 
  theme_void()

```

Por fim, com objetivo meramente descritivo, vamos visualizar os dados das Obras Prioritárias em dois gráicos, especificando a liquidação por Secretaria, a liquidação por Subprefeitura (ainda não obtemos os dados de liquidação por Ação Orçamentária).

```{r gráficos Obras Prioritárias, echo=FALSE}
op %>% 
  group_by(Secretaria) %>% 
  summarise(Liquidado_OP = sum(valor_liquidado_total)) %>% 
  ggplot() +
  geom_col(aes(x = Liquidado_OP,
               y = Secretaria),
           show.legend = TRUE) +
  labs(title = "Obras Prioritárias por Órgãos") +
  theme_minimal()
  
#gráfico por Sub
op %>% 
  group_by(sp_nome) %>% 
  summarise(Liquidado_OP = sum(valor_liquidado_total)) %>% 
  ggplot() +
  geom_col(aes(x = Liquidado_OP,
               y = sp_nome),
           show.legend = TRUE) +
  labs(title = "Obras Prioritárias por Subprefeitura") +
  theme_minimal()
```

###  Base do Orçamento Cidadão

Vamos incluir a base do Orçamento cidadão, encaminhada pela Secretaria da Fazenda (SF) e tratada por SEPEP para desvincular os projetos que também estão inseridos no escopo do Programa de Metas.

```{r Base Orçamento Cidadão, echo=FALSE}


df_oc1 <- readxl::read_excel("Planilha_OC_23_v2.xlsx")
df_oc <- df_oc1 %>% 
  filter(IDRGP == "Sim") %>% 
  select(`Nº Proposta`, DOTACAO, Secretaria, Subprefeitura, Liquidação)
df_oc<- df_oc %>% 
  rename("META"="Nº Proposta",
         sp_nome = Subprefeitura)
df_oc <- df_oc %>% 
  mutate(Liquidação = as.numeric(Liquidação))
df_oc <- df_oc %>% 
  mutate("sp_nome" = case_when(
    sp_nome %in% "Aricanduva/Formosa/Carrão" ~ "Subprefeitura Aricanduva/Formosa/Carrão",
    sp_nome %in% "Butantã" ~ "Subprefeitura Butantã",
    sp_nome %in% "Campo Limpo" ~ "Subprefeitura Campo Limpo",
    sp_nome %in% "Capela do Socorro" ~ "Subprefeitura Capela do Socorro",
    sp_nome %in% "Casa Verde" ~ "Subprefeitura Casa Verde/Cachoeirinha",
    sp_nome %in% "Cidade Ademar" ~ "Subprefeitura Cidade Ademar",
    sp_nome %in% "Cidade Tiradentes" ~ "Subprefeitura Cidade Tiradentes",
    sp_nome %in% "Ermelino Matarazzo" ~ "Subprefeitura Ermelino Matarazzo",
    sp_nome %in% "Freguesia/Brasilândia" ~ "Subprefeitura Freguesia/Brasilândia",
    sp_nome %in% "Guaianases" ~ "Subprefeitura de Guaianases",
    sp_nome %in% "Ipiranga" ~ "Subprefeitura Ipiranga",
    sp_nome %in% "Itaim Paulista" ~ "Subprefeitura Itaim Paulista",
    sp_nome %in% "Itaquera" ~ "Subprefeitura Itaquera",
    sp_nome %in% "Jabaquara" ~ "Subprefeitura Jabaquara",
    sp_nome %in% "Jaçanã/Tremembé" ~ "Subprefeitura Jaçanã/Tremembé",
    sp_nome %in% "Lapa" ~ "Subprefeitura Lapa",
    sp_nome %in% "M'Boi Mirim" ~ "Subprefeitura M'Boi Mirim",
    sp_nome %in% "Mooca" ~ "Subprefeitura Mooca",
    sp_nome %in% "Parelheiros" ~ "Subprefeitura Parelheiros",
    sp_nome %in% "Penha" ~ "Subprefeitura Penha",
    sp_nome %in% "Perus/Anhanguera" ~ "Subprefeitura Perus/Anhanguera",
    sp_nome %in% "Pinheiros" ~ "Subprefeitura Pinheiros",
    sp_nome %in% "Pirituba/Jaraguá" ~ "Subprefeitura Pirituba/Jaraguá",
    sp_nome %in% "Santana/Tucuruvi" ~ "Subprefeitura Santana/Tucuruvi",
    sp_nome %in% "Santo Amaro" ~ "Subprefeitura Santo Amaro",
    sp_nome %in% "São Mateus" ~ "Subprefeitura São Mateus",
    sp_nome %in% "São Miguel Paulista" ~ "Subprefeitura São Miguel Paulista",
    sp_nome %in% "Sapopemba" ~ "Subprefeitura Sapopemba",
    sp_nome %in% "Sé" ~ "Subprefeitura Sé",
    sp_nome %in% "Vila Maria/Vila Guilherme" ~ "Subprefeitura Vila Maria/Vila Guilherme",
    sp_nome %in% "Vila Mariana" ~ "Subprefeitura Vila Mariana",
    TRUE ~ "Subprefeitura de Vila Prudente")) 

df_oc <- df_oc %>% 
  mutate(acao_orc = stringr::str_sub(DOTACAO, start = 19, end = 23))


df_sub_oc <- df_oc %>% 
  group_by(sp_nome) %>% 
  summarise(total_oc = sum(Liquidação))
sum(df_sub_oc$total_oc)
print(df_sub_oc)
```

Os valores do Orçamento Cidadão estão concentrados em apenas 6 subprefeituras, totalizando R\$ 35.400.344.

Agora vamos construir uma base do Orçamento Cidadão com os dados de georreferenciamento para, posteriormente, juntar com as bases do PdM e das Obras Prioritárias.

```{r Base orçamento Cidadão Georreferênciada, echo=FALSE}

idrgp_oc<- full_join(subprefeitura, df_sub_oc, by = "sp_nome")
idrgp_oc<- idrgp_oc %>% 
  mutate(total_oc = ifelse( is.na(total_oc), 0, total_oc))

idrgp_oc %>% 
  ggplot() +
  geom_sf(aes(fill = total_oc, geometry = geometry)) +
  scale_fill_gradient(low="white",high="blue") +
  geom_sf_text(aes(label = sigla), color = "black", size = 1.5, fontface = "bold") + 
  theme_void()
```

Por fim, com objetivo meramente descritivo, vamos visualizar os dados do Orçamento Cidadão em três gráicos, especificando a liquidação por Secretaria, a liquidação por Subprefeitura e a liquidação por Ação Orçamentária.

```{r Gráficos do orçamento Cidadão, echo=FALSE}

#gráfico por órgão:
df_oc %>% 
  group_by(Secretaria) %>% 
  summarise(Liquidado_OC = sum(Liquidação)) %>% 
  ggplot() +
  geom_col(aes(x = Liquidado_OC,
               y = Secretaria),
           show.legend = TRUE) +
  labs(title = "Orçamento cidadão por Órgãos") +
  theme_minimal()
  
#gráfico por Sub
df_oc %>% 
  group_by(sp_nome) %>% 
  summarise(Liquidado_OC = sum(Liquidação)) %>% 
  ggplot() +
  geom_col(aes(x = Liquidado_OC,
               y = sp_nome),
           show.legend = TRUE) +
  labs(title = "Orçamento cidadão por Subprefeitura") +
  theme_minimal()

#gráfico por ação orçamentária
df_oc %>% 
  group_by(acao_orc) %>% 
  summarise(Liquidado_OC = sum(Liquidação)) %>% 
  ggplot() +
  geom_col(aes(x = Liquidado_OC,
               y = acao_orc),
           show.legend = TRUE) +
  labs(title = "Orçamento cidadão por Ação Orçamentária") +
  theme_minimal()

##
```

### Criando uma base única para o cálculo do IDRGP

Agora vamos juntar as bases do Orçamento Cidadão, Obras Prioritárias [e Programa de Metas] para clacular o IdRGP.

Além disso, também vamos calculara soma total do valor liquidado por subprefeitura; o percentual que esse valor representa entre elas e a diferença entre esse percentual e o percentual de referencia do IDRGP.

```{r Valores totais, echo=FALSE}

#Junatndo bancos
idrgp<- full_join(obras_prioritarias, df_sub_oc, by = "sp_nome")
idrgp<- full_join(subprefeitura, idrgp, by = "sp_nome")

idrgp<- idrgp %>% 
  mutate(total_oc = ifelse( is.na(total_oc), 0, total_oc))
idrgp<- idrgp %>% 
  mutate(total_idrgp_23 = total_oc + total_op,
         p_liq_23 = total_idrgp/sum(total_idrgp), 
         diferenca23 = p_liq_23 - ref_idrgp)
idrgp %>% select(NOME, total_idrgp, p_liq_23, diferenca23)

```

### Intervalo de confiança

Agora, vamos calclualr o intervalo de confiança para o índice de referÊncia. Para isso, primeiramente, vamos avaliar se os dados correspondem a uma distribuição normal.

Primeiramente, realizaremos um teste Shapiro de Normalidade e, na sequência, um Teste Kolmogorov-Smirnov.

```{r Testes de normalidade, echo=FALSE}

# Teste Shapiro. testa na normalidade dos dados do índice de referância.
shapiro.test(idrgp$ref_idrgp)
#O p-valor for < 0.05 indica que os dados não apresentam normalidade.
# No caso, o resultado encontrado aponta que os dados poderiam ser enquadrados numa distribuição normal.

# Teste Kolmogorov-Smirnov. Também tesa a normalidade dos dados.
ks.test(idrgp$ref_idrgp,"pnorm",mean(idrgp$ref_idrgp),sd(idrgp$ref_idrgp))
# O tsste também resultou em (não rejeição) curva normal para os dados. 

```

Ambos os testes não rejeitaram a aproximação dos dados de referência do IDRGP como uma curva normal.

Com isso, torna-se possível construir um intervalo de confiança tanto a partir do desvio padrão, quanto a partir de um t.test pareando a distribuição do índice de referência e o percentual total.

Calcularemos os dois:

-   Para o cálculo do intervalo de confiança tradicional, adotaremos o rigor de 3 sigmas, sobre o valor de referência do IRDGP.

-   Para o t.test pareado, manteremos o padrão de 95% de confiança, pois as curvas já estão se ajustando entre si pela diferença.

```{r Intervalo de Confiança, echo= FALSE}

#Intervalo de confiança com 3 sigmas
idrgp<- idrgp %>% 
  mutate(int_inf= ref_idrgp - 3*(sd(ref_idrgp)/sqrt(32)),
         int_sup= ref_idrgp + 3*(sd(ref_idrgp)/sqrt(32)))
idrgp<- idrgp %>% 
  mutate("Status1" = case_when(
    idrgp$p_liq_23 <  int_inf ~ "Aquem da referência do IDRGP",
    idrgp$p_liq_23 >  int_sup ~ "Acima da referência do IDRGP",
    TRUE ~ "Dentro da referência"))


teste_t<-t.test(idrgp$ref_idrgp, idrgp$p_liq_23, paired = T)
idrgp<- idrgp %>% 
  mutate("Status2" = case_when(
    idrgp$diferenca23 <  teste_t$conf.int[1] ~ "Aquem da referência do IDRGP",
    idrgp$diferenca23 >  teste_t$conf.int[2] ~ "Acima da referência do IDRGP",
    TRUE ~ "Dentro da referência"))

idrgp %>% select(NOME, Status1, Status2)
case_when(idrgp$Status1 != idrgp$Status2 ~ idrgp$NOME)


```

O resulado do primeiro intervalo é relativamente próximo ao t.test (95%), a única diferença foi para a Subprefeitura de Campo Limpo [Confirmar após ter os dados do PdM]

Podemos visualizar a distribuição da distância entre o valor de referênncia e os resultados de 2023 nos gráficos abaixo, referentes a cada intervalo de confiança adotado.

```{r gráficos de diferença, echo=FALSE }
# Gráfico da distância 1
idrgp %>% 
  ggplot() +
  geom_col(aes(x = diferenca23,
               y = NOME,
               fill = Status1),
           show.legend = T) +
  scale_fill_manual(values = c("yellow", "red", "blue")) +
  labs(title = "Distâcias do IDRGP 2023 ao referencial",
       y = "") +
  theme_minimal()

# Gráfico da distância 2
idrgp %>% 
  ggplot() +
  geom_col(aes(x = diferenca23,
               y = NOME,
               fill = Status2),
           show.legend = T) +
  scale_fill_manual(values = c("yellow", "red", "blue")) +
  labs(title = "Distâcias do IDRGP 2023 ao referencial",
       y = "") +
  theme_minimal()

```

### Visualizações Gráficas

Para melhor compreender a distribuição do IDRGP no território da cidade, apresentamos abaixo três mapas.

-   O primiro oferece a visualização do valor total liquidado em cada uma das Subprefeituras, segundo o que foi apurado para o IDRGP.
-   O segundo, corresponde ao índice em si, isto é o cálculo da diferença entre o valor de referencia e o percentual do orçamento liquidado por Subprefeitura.
-   Finalente, o terceiro, permite visualizar a composição do índice, de acordo com o intervalo de confiança de 95% a partir do teste t pareado.

```{r Mapas, echo=FALSE}

# Mapa 1 - valor liquidado 2023
idrgp %>% 
  ggplot()+
  geom_sf(aes(fill = total_idrgp_23, geometry = geometry)) +
  scale_fill_gradient(low="white",high="blue") +
  geom_sf_text(aes(label = sigla), color = "black", size = 2, fontface = "bold") +
  theme_void() +
  labs(title = "Valor liquidado utilizado no cálculo do IDRGP 2023*",
       caption = "Fonte: PMSP/SOF; SMADS; SME; SMS. Elaboração: SGM/SEPEP/CP.",
       x = NULL, y = NULL)

# Mapa 2 - diferença 2023
idrgp %>% 
  ggplot()+
  geom_sf(aes(fill = diferenca23, geometry = geometry)) +
  scale_fill_gradient(low="red",high="yellow") +
  geom_sf_text(aes(label = sigla), color = "white", size = 2, fontface = "bold") +
  theme_void() +
  labs(title = "Índice da Distribuição Regional do Gasto Público, 2023*",
       subtitle = "*Diferença entre valor de refencia do índice e o percentual liquidado do orçamento ",
       fill = "Diferença",
       caption = "Fonte: PMSP/SOF; SMADS; SME; SMS. Elaboração: SGM/SEPEP/CP.",
       x = NULL, y = NULL)

# mapa 3 - análise IDRGP
idrgp %>% 
  ggplot()+
  geom_sf(aes(fill = Status2)) +
  scale_fill_manual(values = c("yellow","red", "blue")) +
  geom_sf_text(aes(label = sigla), color = "white", size = 2, fontface = "bold") +
  theme_void() +
  labs(title = "Variação significativa do gasto de 2023 da referência do IDRGP",
       subtitle = "t.test pareado com intervalo de confiança de 95%",
       fill = "Aproximação do IDRGP",
       caption = "Fonte: PMSP/SOF; SMADS; SME; SMS. Elaboração: SGM/SEPEP/CP.",
       x = NULL, y = NULL)
```
