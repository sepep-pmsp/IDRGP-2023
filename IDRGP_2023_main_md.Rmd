---
title: "IDRGP 2023"
author: "FPR e DG"
date: "2024-04-05"
output:
  pdf_document: default
  html_document: default
---

# IDRGP 2023

## **Script para o monitoramento do IDRGP no exercício de 2023**

### Intodução

**Objetivo**: levantar, tratar e analisar dados dos valores executados, nas regiões da cidade de são paulo a partir de uma cesta de desepesas selecionadas, que incluem o Programa de Metas 2021-2024 Versão Alteração Programática, uma lista de obras monitoradas e intervenções do Orçamento Cidadão

### Pacotes utilizados:

```{r Pacotes, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

library(tidyverse)
library(readxl)
library(sf)
library(tinytex)
library(janitor)


base::options(scipen = 99)

```

### Valores de referência do IDRGP

Inicialmente, inserimos os valores de referência do IDRGP:

```{r Valores de referência, echo=FALSE, message=FALSE, warning=FALSE}
(ref_idrgp <- dplyr::tibble(sp_nome = c("Subprefeitura Capela do Socorro",
                                        "Subprefeitura M'Boi Mirim",
                                        "Subprefeitura Campo Limpo",
                                        "Subprefeitura São Mateus",
                                        "Subprefeitura Itaquera",
                                        "Subprefeitura Cidade Ademar",
                                        "Subprefeitura Freguesia/Brasilândia",
                                        "Subprefeitura São Miguel Paulista",
                                        "Subprefeitura Itaim Paulista",
                                        "Subprefeitura Pirituba/Jaraguá",
                                        "Subprefeitura Parelheiros",
                                        "Subprefeitura Jaçanã/Tremembé",
                                        "Subprefeitura Sapopemba",
                                        "Subprefeitura de Guaianases",
                                        "Subprefeitura Penha",
                                        "Subprefeitura Ipiranga",
                                        "Subprefeitura Cidade Tiradentes",
                                        "Subprefeitura Casa Verde/Cachoeirinha",
                                        "Subprefeitura Perus/Anhanguera",
                                        "Subprefeitura Butantã",
                                        "Subprefeitura Ermelino Matarazzo",
                                        "Subprefeitura de Vila Prudente",
                                        "Subprefeitura Sé",
                                        "Subprefeitura Vila Maria/Vila Guilherme",
                                        "Subprefeitura Aricanduva/Formosa/Carrão",
                                        "Subprefeitura Jabaquara",
                                        "Subprefeitura Mooca",
                                        "Subprefeitura Santana/Tucuruvi",
                                        "Subprefeitura Lapa",
                                        "Subprefeitura Santo Amaro",
                                        "Subprefeitura Vila Mariana",
                                        "Subprefeitura Pinheiros"),
  ref_idrgp = c(0.0708, 0.0706, 0.0616, 0.0511, 0.0487, 0.0483, 0.0456, 0.0419,
                0.0406, 0.0377, 0.0374, 0.0364, 0.0353, 0.0346, 0.0346, 0.0291,
                0.0278, 0.0270, 0.0258, 0.0250, 0.0210, 0.0183, 0.0179, 0.0167,
                0.0157, 0.0150, 0.0150, 0.0146, 0.0113, 0.0094, 0.0086, 0.0068)) %>% 
  arrange(desc(ref_idrgp)))
```

### Base cartográfica do Município

Em seguida, inserimos a base cartográfica do município de São Paulo obtida a partir do GeoSampa.

A partir dela, selecionamos os dados das Subprefeituras com os valores de referência do índice.

```{r Cartografia, echo=FALSE, message=FALSE, warning=FALSE}
sp <- read_sf("SIRGAS_SHP_subprefeitura//SIRGAS_SHP_subprefeitura_polygon.shp")

subprefeitura <- sp %>% 
    rename(sigla = sp_sigla,
           NOME=sp_nome) %>% 
    select(NOME, sigla, geometry)
subprefeitura<- subprefeitura %>% 
  mutate(sp_nome = case_when(
    sigla %in% "AF" ~ "Subprefeitura Aricanduva/Formosa/Carrão",
    sigla %in% "BT" ~ "Subprefeitura Butantã",
    sigla %in% "CL" ~ "Subprefeitura Campo Limpo",
    sigla %in% "CS" ~ "Subprefeitura Capela do Socorro",
    sigla %in% "CV" ~ "Subprefeitura Casa Verde/Cachoeirinha",
    sigla %in% "CAA" ~ "Subprefeitura Cidade Ademar",
    sigla %in% "CT" ~ "Subprefeitura Cidade Tiradentes",
    sigla %in% "EM" ~ "Subprefeitura Ermelino Matarazzo",
    sigla %in% "FO" ~ "Subprefeitura Freguesia/Brasilândia",
    sigla %in% "GU" ~ "Subprefeitura de Guaianases",
    sigla %in% "IP" ~ "Subprefeitura Ipiranga",
    sigla %in% "IP" ~ "Subprefeitura Itaim Paulista",
    sigla %in% "IT" ~ "Subprefeitura Itaquera",
    sigla %in% "JA" ~ "Subprefeitura Jabaquara",
    sigla %in% "JT" ~ "Subprefeitura Jaçanã/Tremembé",
    sigla %in% "LA" ~ "Subprefeitura Lapa",
    sigla %in% "MB" ~ "Subprefeitura M'Boi Mirim",
    sigla %in% "MO" ~ "Subprefeitura Mooca",
    sigla %in% "PA" ~ "Subprefeitura Parelheiros",
    sigla %in% "PE" ~ "Subprefeitura Penha",
    sigla %in% "PR" ~ "Subprefeitura Perus/Anhanguera",
    sigla %in% "PI" ~ "Subprefeitura Pinheiros",
    sigla %in% "PJ" ~ "Subprefeitura Pirituba/Jaraguá",
    sigla %in% "ST" ~ "Subprefeitura Santana/Tucuruvi",
    sigla %in% "SA" ~ "Subprefeitura Santo Amaro",
    sigla %in% "SM" ~ "Subprefeitura São Mateus",
    sigla %in% "MP" ~ "Subprefeitura São Miguel Paulista",
    sigla %in% "SB" ~ "Subprefeitura Sapopemba",
    sigla %in% "SE" ~ "Subprefeitura Sé",
    sigla %in% "MG" ~ "Subprefeitura Vila Maria/Vila Guilherme",
    sigla %in% "VM" ~ "Subprefeitura Vila Mariana",
    TRUE ~ "Subprefeitura de Vila Prudente"))

subprefeitura <- inner_join(subprefeitura, ref_idrgp, by = "sp_nome")
#teste do mapa com siglas
subprefeitura %>% 
  ggplot() +
  geom_sf(aes(fill = ref_idrgp, geometry = geometry)) +
  scale_fill_gradient(low="red",high="blue") +
  geom_sf_text(aes(label = sigla), color = "black", size = 1.5, fontface = "bold") + 
  theme_void()

```

### Bases do PdM 2021-2024

Nesta seção, detalhamos os processos de obtenção e transformação dos dados de execução física e orçamentária do Programa de Metas. Para efeitos de monitoramento do IDRGP 2023, são considerados 29 compromissos do Programa de Metas 2021-2024 versão Alteração Programática. Tanto os dados de execução física quanto os da execução orçamentária são inseridos por cada órgão responsável no Sistema de Monitoramento e Acompanhamento Estratégico (SMAE).

Os dados de execução física são, nas metas selecionadas para o IDRGP 2023, desagregadas em nível regional (subprefeitura), podendo, dessa forma, serem extraídos diretamente do SMAE. Para tornar o presente relatório replicável, optou-se por utilizar como fonte sobre a execução física os dados abertos do PdM, disponível em: \<[ ]().

Os dados de execução orçamentária correspondem à liquidação das dotações orçamentárias que abarcam despesas vinculadas ao Programa de Metas. Como os dados abertos apresentam os valores empenhados e, para fins de monitoramento do IDRGP, interessam os valores liquidados, extraiu-se um relatório do SAME, em 04/03/2024, registrado nas abas "totais_metas, do documento "metas_alteracao_programatica.xlsx". Para a desagregação regional destes dados, lançou-se mão de duas estratégias:

-   Coleta de dados diretamente com os órgãos, nos casos das Metas 3, 4, 5, 7, 8, 9, 78 e 79, sob responsabilidade da Secretaria Municpal de Saúde (SMS) e da Meta 58, conduzida pela Secretaria Municipal de Cultura (SMC). Tais informações encontram-se na aba "totais_inf_orgaos", do documento "metas_alteracao_programatica.xlsx";
-   Cálculo da razão entre o valor liquidado e a execução física, por região, para a Meta 17;
-   Regionalização a partir do "Detalhamento da Ação", por meio de consulta a dados publicados pela Secretaria da Fazenda (SF). A base de dados da regionalização da execução orçamentária do exercício de 2023, pode ser extraída por meio do portal: \<[[https://orcamento.sf.prefeitura.sp.gov.br/orcamente/execucao.php\\\\](https://orcamento.sf.prefeitura.sp.gov.br/orcamente/execucao.php){.uri}](%5Bhttps://orcamento.sf.prefeitura.sp.gov.br/orcamente/execucao.php\%5D(https://orcamento.sf.prefeitura.sp.gov.br/orcamente/execucao.php)%7B.uri%7D){.uri}\>, nos formatos "[.csv](https://orcamento.sf.prefeitura.sp.gov.br/orcamento/uploads/2023/basedadosDA_1223.csv)", "[.xlsx](https://orcamento.sf.prefeitura.sp.gov.br/orcamento/uploads/2023/basedadosDA_1223.xlsx)", "[.ods](https://orcamento.sf.prefeitura.sp.gov.br/orcamento/uploads/2023/basedadosDA_1223.ods)" ou "[.json](https://orcamento.sf.prefeitura.sp.gov.br/orcamento/uploads/2023/basedadosDA_1223.json)"

Há casos em que a execução orçamentária da dotação foi integralmente dedicada ao Programa de Metas. Nesses casos, o valor regionalizado pelo detalhamento da ação corresponde ao valor regionalizado das metas consideradas para o IDRGP 2023.

Nos casos em que a dotação orçamentária não abarcou desepesas exclusivas do Programa de Metas, assumiu-se que a execução regionalizada da meta foi proporcional à regioanlização pelo detalhamento da ação.

Para que não houvesse perda de dados ao inserir as informações fornecidas diretamente por SMS e SMS, o documento "metas_alteracao_programatica.xlsx" abarca uma aba contendo a mesma base da aba "totais_metas", substituindo as linhas correspondentes às metas 3, 4, 5, 7, 8, 9, 58, 78 e 79 pelos valores informados pelos órgõas. Esta base encontra-se na aba "totais_metas_inf_orgaos".

Introduzidas as passagens que originaram os dados da execução física e orçamentária do Programa de Metas, apresentamos, a seguir, as manipulações necessárias para a análise dos dados, a começar pela importação dos dados.

```{r}


#ler a aba totais_metas
(base_smae <- readxl::read_excel("metas_alteracao_programatica.xlsx", sheet = "totais_metas", skip = 266) %>% 
   dplyr::select(-c("Diferença Soma dos valores proporcionais vs SMAE",
                    "Observações",
                    "...46",
                    "supra",
                    "...48",
                    "zero")))

#transformar as colunas de subprefeituras e supra subprefeituras em uma única coluna
base_smae <- base_smae %>% 
    tidyr::pivot_longer(
      cols = c("Subprefeitura Aricanduva/Formosa/Carrão":"SE+SUPRACENTRO"),
      names_to = "subprefeitura",
      values_to = "valor_da") %>% 
  janitor::clean_names()

base_smae <- base_smae %>% 
  filter(meta != 10 & subprefeitura != c("Subprefeitura Sé", "Supra Subprefeitura Centro")) %>% #meta 10 não faz parte do IDRGP e Sub Sé e Supra Centro já estão somados na planilha na coluna SE+SUPRACENTRO
  mutate(subprefeitura = if_else(subprefeitura == "SE+SUPRACENTRO", "Subprefeitura Sé", subprefeitura)) #remover dupla-contagem entre Sub Sé e Supra centro

#ler a aba totais_metas_inf_orgaos
base_inf_orgaos <- readxl::read_excel("metas_alteracao_programatica.xlsx", sheet = "totais_metas_inf_orgaos", skip = 266) %>% 
    dplyr::select(-c("Diferença Soma dos valores proporcionais vs SMAE", "Observações")) %>% 
    dplyr::rename("SE+SUPRACENTRO" = "SE+SUPRA_CENTRO") #para padronizar os nomes dessas colunas

#transformar as colunas de subprefeituras e supra subprefeituras em uma única coluna
base_inf_orgaos <- base_inf_orgaos %>% 
    tidyr::pivot_longer(
      cols = c("Subprefeitura Aricanduva/Formosa/Carrão":"SE+SUPRACENTRO"),
      names_to = "subprefeitura",
      values_to = "valor_da_inf_orgao") %>%
  janitor::clean_names() %>% 
    dplyr::select(meta, dotacao, subprefeitura, valor_da_inf_orgao)

base_inf_orgaos <- base_inf_orgaos %>% 
  filter(meta != 10 & subprefeitura != c("Subprefeitura Sé", "Supra Subprefeitura Centro")) %>% 
  mutate(subprefeitura = if_else(subprefeitura == "SE+SUPRACENTRO", "Subprefeitura Sé", subprefeitura))


## juntar base_smae e base_inf_orgaos
(df_pdm <- dplyr::full_join(base_smae, base_inf_orgaos, by = c("meta", "dotacao", "subprefeitura")) %>% 
    dplyr::distinct())

df_pdm$valor_da_inf_orgao <- df_pdm$valor_da_inf_orgao %>% tidyr::replace_na(0) #substituir NA por 0

d <- df_pdm %>% 
  filter(subprefeitura == "Subprefeitura Sé")

sum(d$valor_da, na.rm = TRUE)

rm(d)

# ajustar NA da meta 84
f <- df_pdm %>% 
  filter(meta == 84) %>% 
  fill(orgao, txt_meta, .direction = "down") %>% 
  replace_na(list(total_smae = 14108628, valor_da = 0))

df_pdm <- df_pdm %>% 
  filter(meta != 84) %>% 
  bind_rows(f)

# checar valores
base::sum(df_pdm$valor_da, na.rm = TRUE)-base::sum(base_smae$valor_da, na.rm = TRUE)
base::sum(df_pdm$valor_da_inf_orgao, na.rm = TRUE)-base::sum(base_inf_orgaos$valor_da_inf_orgao, na.rm = TRUE)

c <- df_pdm %>% 
  group_by(dotacao) %>%
  select(dotacao, total_smae) %>% 
  distinct()

sum(c$total_smae, na.rm = TRUE) #3116974852

rm(c)

colnames(df_pdm)

rm(b)
b <- df_pdm %>% 
  select(-subprefeitura, -valor_da, -valor_da_inf_orgao) %>% 
  group_by(dotacao) %>% 
  filter(total_smae > 0) %>% 
  distinct()

```

Ao consolidar a base de dados do Programa de Metas, identificou-se alguma movimentação equivocada que gerou divergência nas somas de totais para checagem, tanto na coluna valor_da quanto na coluna valor_da_inf_orgao. O bloco, a seguir, busca explorar e sanear o problema.

```{r paged.print=TRUE}

# obter base de dados do DA
base_da <- readr::read_csv2("https://orcamento.sf.prefeitura.sp.gov.br/orcamento/uploads/2023/basedadosDA_1223.csv",
                          locale = locale(encoding = "latin1")) %>% 
  janitor::clean_names()

base::names(base_da)

# criar coluna com a codificação da dotação orçamentária
base_da1 <- base_da %>% 
  dplyr::mutate(dotacao = base::paste(codigo_orgao,
                                      codigo_unidade,
                                      codigo_funcao,
                                      codigo_subfuncao,
                                      codigo_programa,
                                      codigo_proj_ativ,
                                      codigo_conta_despesa,
                                      codigo_fonte,
                                      codigo_exercicio_fonte,
                                      codigo_destinacao_recurso,
                                      codigo_vinculo_pmsp,
                                      codigo_tipo_credito_orcamentario,
                                      sep = "."),
                dotacao = base::sub('^(.{19})', '\\1.', dotacao)) %>% 
  dplyr::select(dotacao, sigla_orgao, regiao, subprefeitura, distrito, tipo_regionalizacao, valor_detalhamento_acao) %>%   dplyr::group_by(dotacao, subprefeitura) %>% 
  dplyr::summarise(sigla_orgao = first(sigla_orgao),
                   regiao = first(regiao),
                   subprefeitura = first(subprefeitura),
                   distrito = first(distrito),
                   tipo_regionalizacao = first(tipo_regionalizacao),
                   valor_detalhamento_acao = sum(valor_detalhamento_acao)) %>% 
  dplyr::filter(tipo_regionalizacao == "Despesa Regionalizável")


# checar existência de NA
base_da1 %>%
  summarise_all(~ any(is.na(.))) #não há NA

# transformar subprefeitura=="Supra Subprefeitura Centro" em "Subprefeitura Sé"
base_da1 <- base_da1 %>% 
  mutate(subprefeitura = case_when(
    subprefeitura %in% "Supra Subprefeitura Centro" ~ "Subprefeitura Sé",
    TRUE ~ subprefeitura)
  )

soma_da_base2 <- sum(base_da1$valor_detalhamento_acao)

## Ratear valores de subprefeitura=="Supra Subprefeitura Região X" nas respectivas subprefeituras da Região X
suporte_rateio_regioes <- base_da1 %>% 
  filter(subprefeitura %in% c("Supra Subprefeitura Leste",
                          "Supra Subprefeitura Norte",
                          "Supra Subprefeitura Oeste",
                          "Supra Subprefeitura Sul")) #df apenas do que tem "supra" na coluna dotacao

sum(suporte_rateio_regioes$valor_detalhamento_acao) #441164215

(n_sub_regioes <- base_da1 %>% 
  filter(!str_detect(subprefeitura, "Supra")) %>% 
  group_by(regiao) %>% 
  summarise(count = n_distinct(subprefeitura))) #número de subprefeituras por região

(suporte_rateio_regioes <- suporte_rateio_regioes %>% 
  left_join(n_sub_regioes, by = "regiao") %>% 
  mutate(valor_rateio = valor_detalhamento_acao / count) %>% 
  arrange(dotacao))

sum(suporte_rateio_regioes$valor_rateio) #64756605

(suporte_rateio_regioes <- suporte_rateio_regioes %>% 
    select(-subprefeitura, -distrito, -valor_detalhamento_acao, -tipo_regionalizacao))

(teste <- base_da1 %>%
  left_join(suporte_rateio_regioes, by = c("dotacao", "sigla_orgao", "regiao")) %>% 
  replace_na(list(count = 0, valor_rateio = 0)) %>% 
    distinct())

sum(teste$valor_rateio, na.rm = TRUE)#169872656

rm("teste")



```

Observou-se que *teste-valor_rateio* e *suporte_rateio_regioes-valor_detalhamento_acao* possuem valores diferentes.

Isso ocorre, pois uma série de dotações são apenas supra regionais. É necessário, então, complementar a base_da1, com todas as subprefeituras para todas as dotações, para diluir os valores supra regionais nas respectivas subprefeiutras de cada região. Antes de acrescentar os valores proporcionais, vamos incluir as informações origundas dos df base_smae e base_inf_orgaos e tratar as dotações que possuem a codificação incompleta.

```{r}


# criar objeto comp_sub_dot com todas as combinações de dotações e subprefeituras
comp_sub_dot <- expand_grid(dotacao = unique(base_da1$dotacao),
                 subprefeitura = unique(base_da1$subprefeitura))

# acrescentar regiao ao objeto comp_sub_dot
(comp_sub_dot <- comp_sub_dot %>% 
  mutate(regiao = case_when(
    subprefeitura %in% c("Subprefeitura Aricanduva/Formosa/Carrão",
                   "Subprefeitura Cidade Tiradentes",
                   "Subprefeitura de Guaianases",
                   "Subprefeitura de Vila Prudente",
                   "Subprefeitura Ermelino Matarazzo",
                   "Subprefeitura Itaim Paulista",
                   "Subprefeitura Itaquera",
                   "Subprefeitura Mooca",
                   "Subprefeitura Penha",
                   "Subprefeitura São Mateus",
                   "Subprefeitura São Miguel Paulista",
                   "Subprefeitura Sapopemba",
                   "Supra Subprefeitura Leste") ~ "Leste",
    subprefeitura %in% c("Subprefeitura Butantã",
                   "Subprefeitura Lapa",
                   "Subprefeitura Pinheiros",
                   "Supra Subprefeitura Oeste") ~ "Oeste",
    subprefeitura %in% c("Subprefeitura Casa Verde/Cachoeirinha",
                   "Subprefeitura Freguesia/Brasilândia",
                   "Subprefeitura Jaçanã/Tremembé",
                   "Subprefeitura Perus/Anhanguera",
                   "Subprefeitura Pirituba/Jaraguá",
                   "Subprefeitura Santana/Tucuruvi",
                   "Subprefeitura Vila Maria/Vila Guilherme",
                   "Supra Subprefeitura Norte") ~ "Norte",
    subprefeitura %in% c("Subprefeitura Sé",
                   "Supra Subprefeitura Centro") ~ "Centro",
    TRUE ~ "Sul")))

#acrescentar sigla_orgao
(a <- base_da1 %>% 
    select(c("dotacao", "sigla_orgao")))

comp_sub_dot <- comp_sub_dot %>% 
  left_join(a, by = "dotacao") %>% 
  select("dotacao", "sigla_orgao", "subprefeitura", "regiao") %>% 
  distinct()

rm(a)

#juntar valor_detalhamento_acao
comp_sub_dot <- comp_sub_dot %>% 
  full_join(base_da1, by = c("dotacao", "sigla_orgao", "subprefeitura", "regiao")) %>% 
  distinct() %>% 
  replace_na(list(valor_detalhamento_acao = 0)) %>% 
  select(-distrito, -tipo_regionalizacao)

sum(comp_sub_dot$valor_detalhamento_acao) == soma_da_base2

# trazer informação do valor liquidado registrado no smae e do valor_inf_orgao para acrescentar a comp_sub_dot
comp_sub_dot <- comp_sub_dot %>% 
  full_join(df_pdm, by = intersect(names(df_pdm), names(comp_sub_dot))) %>% 
  distinct() %>% 
  replace_na(list(total_smae = 0, valor_da = 0, valor_da_inf_orgao = 0))

a <- base_da1 %>% 
  full_join(b, by = intersect(names(b), names(base_da1))) %>% 
  group_by(dotacao) %>% 
  distinct() %>% 
  replace_na(list(valor_detalhamento_acao = 0, total_smae = 0))

sum(a$valor_detalhamento_acao, na.rm = TRUE) - soma_da_base2

dot_base_da1 <- unique(base_da1$dotacao)

dot_base_a <- unique(a$dotacao)

dot_base_comp_sub_dot <- unique(comp_sub_dot$dotacao)

2925-2859

d <- tibble(
  dotacao = base_da1$dotacao,
  valor = base_da1$valor_detalhamento_acao
)

e <- tibble(
  dotacao = a$dotacao,
  valor = a$valor_detalhamento_acao
)

comb_dot1 <- vector()
comb_dot2 <- vector()
comb_valor1 <- vector()
comb_valor2 <- vector()


# Loop pelos dados de df1
for(i in 1:nrow(d)) {
  for(j in 1:nrow(e)) {
    # Comparar as combinações dot1/valor1 e dot2/valor2
    if(d$dotacao[i] == e$dotacao[j] && d$valor[i] == e$valor[j]) {
      comb_dot1 <- c(comb_dot1, d$dotacao[i])
      comb_dot2 <- c(comb_dot2, e$dotacao[j])
      comb_valor1 <- c(comb_valor1, d$valor[i])
      comb_valor2 <- c(comb_valor2, e$valor[j])
    }
  }
}

# Criar um dataframe com as combinações encontradas
comb_df <- tibble(
  dot1 = comb_dot1,
  dot2 = comb_dot2,
  valor1 = comb_valor1,
  valor2 = comb_valor2)



```

O bloco a seguir faz o tratamento de 13 situações do objeto comp_sub_dot que possuem menos de 48 caracteres, ou seja, a codificação está incompleta.
```{r}

# ajustar dotacoes que não estão com a codificação completa 
comp_sub_dot %>% 
  select(dotacao) %>% 
  filter(str_length(dotacao) < 48) %>% 
  distinct() #13 situações 

#1 14.10.16.451.3002.3.357.44903900.00				
#2 14.10.16.451.3005.3.355.44903900.00
#3 14.10.16.482.3005.3.355.44905100.00	
#4 86.14.16.451.3002.3.357.44903900.03	
#5 98.14.16.482.3002.3.340.44906100.08	
#6 98.14.16.482.3002.3.354.44903900.08	
#7 98.14.16.482.3002.3.354.44905100.08	
#8 98.14.16.482.3005.3.355.44905100.08	
#9 91.10.16.482.3002.3.356.44903900.08.1.759.8011
#10 16.10.12.361.3010.3.365.44905100.00.1.500.0003
#11 98.22.26.453.3009.5.105.44903900.08
#12 98.22.26.453.3009.5.105.44905100.08
#13 25.10.13.392.3001.6.371.3390

#1 14.10.16.451.3002.3.357.44903900.00
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^14\\.10\\.16\\.451\\.3002\\.3\\.357\\.44903900\\.00") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop = valor_detalhamento_acao / total_valor)) # para identificar quantas dotações são abragidas pela dotação incompleta calcular a proporção de cada dotação completa no conjunto abrangido pela dotação incompleta

# neste caso, há apenas uma dotação; então basta remover a dotação incmpleta da base_da_pdm
b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^14\\.10\\.16\\.451\\.3002\\.3\\.357\\.44903900\\.00")& !str_length(dotacao) < 48) #para obter um df com as dotações completas. PS: observou-se algum erro de digitação no valor_da_inf_orgaos, na planilha, o que fez com que alguns registros fossem duplicados. Como haverá novo cálculo dessa coluna posteriormente, vamos atribuir valor 0 a todos os registros nesse campo. Também vamos remover dois registros que ficaram com NA nas colunas silga_orgao, subprefeitura, regiao e valor_detalhamento_acao

b$valor_da_inf_orgao <- 0

b <- b %>% 
  filter(!is.na(valor_detalhamento_acao)) %>% 
  distinct() 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^14\\.10\\.16\\.451\\.3002\\.3\\.357\\.44903900\\.00")) #para remover todos os registros com a dotação em questão (evitar duplicidades)

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(b) # para ter registros com dotações completas

rm(list = c("a", "b"))

#2 14.10.16.451.3005.3.355.44903900.00
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^14\\.10\\.16\\.451\\.3005\\.3\\.355\\.44903900\\.00") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop = valor_detalhamento_acao / total_valor)) 

b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^14\\.10\\.16\\.451\\.3005\\.3\\.355\\.44903900\\.00")& !str_length(dotacao) < 48)

b <- b %>% 
  filter(!is.na(valor_detalhamento_acao)) %>% 
  distinct() 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^14\\.10\\.16\\.451\\.3005\\.3\\.355\\.44903900\\.00"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(b)

rm(list = c("a", "b"))

#3 14.10.16.482.3005.3.355.44905100.00
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^14\\.10\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.00") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor)) # para identificar quantas dotações são abragidas pela dotação incompleta e calcular a proporção de cada dotação completa no conjunto abrangido pela dotação incompleta

# neste caso, há sete dotações; então vamos criar objetos intermediários para substituir as dotações incompletas por um df com a dotação completa
b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^14\\.10\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.00")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^14\\.10\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.00")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

d <- base_da1 %>%
  filter(str_detect(dotacao, "^14\\.10\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.00")) %>% 
  select(-distrito, -tipo_regionalizacao) #df apenas com subs onde houve liquidação

e <- tibble(
  dotacao = d$dotacao,
  sigla_orgao = d$sigla_orgao,
  subprefeitura = d$subprefeitura,
  regiao = d$regiao,
  valor_detalhamento_acao = d$valor_detalhamento_acao,
  orgao = unique(c$orgao),
  meta = unique(c$meta),
  txt_meta = unique(c$txt_meta),
  total_smae = unique(c$total_smae)) # para obter o df que deve ser substituído no objeto comp_sug_dot
  
comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^14\\.10\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.00")) #para excluir as dotações incompletas

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^14\\.10\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.00"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) #df com dotações completas (e informações sobre pdm compatibilizadas)

rm(list = c("a", "b", "c", "d", "e", "f"))

#4 86.14.16.451.3002.3.357.44903900.03
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^86\\.14\\.16\\.451\\.3002\\.3\\.357\\.44903900\\.03") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor)) # para identificar quantas dotações são abragidas pela dotação incompleta e calcular a proporção de cada dotação completa no conjunto abrangido pela dotação incompleta

# neste caso, há duas dotações; então vamos criar objetos intermediários para substituir as dotações incompletas por um df com a dotação completa
b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^86\\.14\\.16\\.451\\.3002\\.3\\.357\\.44903900\\.03")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^86\\.14\\.16\\.451\\.3002\\.3\\.357\\.44903900\\.03")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

c$valor_da <- 0
c$valor_da_inf_orgao <- 0

c <- c %>% 
  distinct()

d <- base_da1 %>%
  filter(str_detect(dotacao, "^86\\.14\\.16\\.451\\.3002\\.3\\.357\\.44903900\\.03")) %>% 
  select(-distrito, -tipo_regionalizacao) 

e <- tibble(
  dotacao = rep(d$dotacao, 2),
  sigla_orgao = rep(d$sigla_orgao, 2),
  subprefeitura = rep(d$subprefeitura, 2),
  regiao = rep(d$regiao, 2),
  valor_detalhamento_acao = rep(d$valor_detalhamento_acao, 2),
  orgao = unique(c$orgao),
  meta = rep(unique(c$meta), 11),
  txt_meta = rep(unique(c$txt_meta), 11),
  total_smae = rep(unique(c$total_smae), 11)) 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^86\\.14\\.16\\.451\\.3002\\.3\\.357\\.44903900\\.03")) 

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^86\\.14\\.16\\.451\\.3002\\.3\\.357\\.44903900\\.03"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) #df com dotações completas (e informações sobre pdm compatibilizadas)

rm(list = c("a", "b", "c", "d", "e"))

#5 98.14.16.482.3002.3.340.44906100.08
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.340\\.44906100\\.08") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor)) # para identificar quantas dotações são abragidas pela dotação incompleta e calcular a proporção de cada dotação completa no conjunto abrangido pela dotação incompleta

# neste caso, há duas dotações; então vamos criar objetos intermediários para substituir as dotações incompletas por um df com a dotação completa
b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.340\\.44906100\\.08")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.340\\.44906100\\.08")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

c$valor_da <- 0
c$valor_da_inf_orgao <- 0

c <- c %>% 
  distinct()

d <- base_da1 %>%
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.340\\.44906100\\.08")) %>% 
  select(-distrito, -tipo_regionalizacao) 

e <- tibble(
  dotacao = rep(d$dotacao),
  sigla_orgao = rep(d$sigla_orgao),
  subprefeitura = rep(d$subprefeitura),
  regiao = rep(d$regiao),
  valor_detalhamento_acao = rep(d$valor_detalhamento_acao),
  orgao = unique(c$orgao),
  meta = rep(unique(c$meta)),
  txt_meta = rep(unique(c$txt_meta)),
  total_smae = rep(unique(c$total_smae))) 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.340\\.44906100\\.08")) 

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.340\\.44906100\\.08"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) 

rm(list = c("a", "b", "c", "d", "e"))

#6 98.14.16.482.3002.3.354.44903900.08
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44903900\\.08") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor))

b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44903900\\.08")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44903900\\.08")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

c$valor_da <- 0
c$valor_da_inf_orgao <- 0

c <- c %>% 
  distinct()

d <- base_da1 %>%
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44903900\\.08")) %>% 
  select(-distrito, -tipo_regionalizacao) 

e <- tibble(
  dotacao = rep(d$dotacao),
  sigla_orgao = rep(d$sigla_orgao),
  subprefeitura = rep(d$subprefeitura),
  regiao = rep(d$regiao),
  valor_detalhamento_acao = rep(d$valor_detalhamento_acao),
  orgao = unique(c$orgao),
  meta = rep(unique(c$meta)),
  txt_meta = rep(unique(c$txt_meta)),
  total_smae = rep(unique(c$total_smae))) 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44903900\\.08")) 

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44903900\\.08"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) 

rm(list = c("a", "b", "c", "d", "e"))

#7 98.14.16.482.3002.3.354.44905100.08	
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44905100\\.08") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor))

b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44905100\\.08")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44905100\\.08")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

c$valor_da <- 0
c$valor_da_inf_orgao <- 0

c <- c %>% 
  distinct()

d <- base_da1 %>%
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44905100\\.08")) %>% 
  select(-distrito, -tipo_regionalizacao) 

e <- tibble(
  dotacao = rep(d$dotacao),
  sigla_orgao = rep(d$sigla_orgao),
  subprefeitura = rep(d$subprefeitura),
  regiao = rep(d$regiao),
  valor_detalhamento_acao = rep(d$valor_detalhamento_acao),
  orgao = unique(c$orgao),
  meta = rep(unique(c$meta)),
  txt_meta = rep(unique(c$txt_meta)),
  total_smae = rep(unique(c$total_smae))) 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44905100\\.08")) 

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3002\\.3\\.354\\.44905100\\.08"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) 

rm(list = c("a", "b", "c", "d", "e"))

#8 98.14.16.482.3005.3.355.44905100.08	
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.08") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor))

b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.08")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.08")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

c$valor_da <- 0
c$valor_da_inf_orgao <- 0

c <- c %>% 
  distinct()

d <- base_da1 %>%
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.08")) %>% 
  select(-distrito, -tipo_regionalizacao) 

e <- tibble(
  dotacao = rep(d$dotacao),
  sigla_orgao = rep(d$sigla_orgao),
  subprefeitura = rep(d$subprefeitura),
  regiao = rep(d$regiao),
  valor_detalhamento_acao = rep(d$valor_detalhamento_acao),
  orgao = unique(c$orgao),
  meta = rep(unique(c$meta)),
  txt_meta = rep(unique(c$txt_meta)),
  total_smae = rep(unique(c$total_smae))) 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^98\\.14\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.08")) 

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.14\\.16\\.482\\.3005\\.3\\.355\\.44905100\\.08"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) 

rm(list = c("a", "b", "c", "d", "e"))

#9 91.10.16.482.3002.3.356.44903900.08.1.759.8011
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^91\\.10\\.16\\.482\\.3002\\.3\\.356\\.44903900\\.08\\.1\\.759\\.8011") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor))

b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^91\\.10\\.16\\.482\\.3002\\.3\\.356\\.44903900\\.08\\.1\\.759\\.8011")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^91\\.10\\.16\\.482\\.3002\\.3\\.356\\.44903900\\.08\\.1\\.759\\.8011")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

c$valor_da <- 0
c$valor_da_inf_orgao <- 0

c <- c %>% 
  distinct()

d <- base_da1 %>%
  filter(str_detect(dotacao, "^91\\.10\\.16\\.482\\.3002\\.3\\.356\\.44903900\\.08\\.1\\.759\\.8011")) %>% 
  select(-distrito, -tipo_regionalizacao) 

e <- tibble(
  dotacao = rep(d$dotacao),
  sigla_orgao = rep(d$sigla_orgao),
  subprefeitura = rep(d$subprefeitura),
  regiao = rep(d$regiao),
  valor_detalhamento_acao = rep(d$valor_detalhamento_acao),
  orgao = unique(c$orgao),
  meta = rep(unique(c$meta)),
  txt_meta = rep(unique(c$txt_meta)),
  total_smae = rep(unique(c$total_smae))) 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^91\\.10\\.16\\.482\\.3002\\.3\\.356\\.44903900\\.08\\.1\\.759\\.8011")) 

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^91\\.10\\.16\\.482\\.3002\\.3\\.356\\.44903900\\.08\\.1\\.759\\.8011"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) 

rm(list = c("a", "b", "c", "d", "e"))	

#10 16.10.12.361.3010.3.365.44905100.00.1.500.0003
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^16\\.10\\.12\\.361\\.3010\\.3\\.365\\.44905100\\.00\\.1\\.500\\.0003") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor))

b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^16\\.10\\.12\\.361\\.3010\\.3\\.365\\.44905100\\.00\\.1\\.500\\.0003")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^16\\.10\\.12\\.361\\.3010\\.3\\.365\\.44905100\\.00\\.1\\.500\\.0003")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

c$valor_da <- 0
c$valor_da_inf_orgao <- 0

c <- c %>% 
  distinct()

d <- base_da1 %>%
  filter(str_detect(dotacao, "^16\\.10\\.12\\.361\\.3010\\.3\\.365\\.44905100\\.00\\.1\\.500\\.0003")) %>% 
  select(-distrito, -tipo_regionalizacao) 

e <- tibble(
  dotacao = rep(d$dotacao),
  sigla_orgao = rep(d$sigla_orgao),
  subprefeitura = rep(d$subprefeitura),
  regiao = rep(d$regiao),
  valor_detalhamento_acao = rep(d$valor_detalhamento_acao),
  orgao = unique(c$orgao),
  meta = rep(unique(c$meta)),
  txt_meta = rep(unique(c$txt_meta)),
  total_smae = rep(unique(c$total_smae))) 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^16\\.10\\.12\\.361\\.3010\\.3\\.365\\.44905100\\.00\\.1\\.500\\.0003")) 

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^16\\.10\\.12\\.361\\.3010\\.3\\.365\\.44905100\\.00\\.1\\.500\\.0003"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) 

rm(list = c("a", "b", "c", "d", "e"))	

#11 98.22.26.453.3009.5.105.44903900.08
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44903900\\.08") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor))

b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44903900\\.08")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44903900\\.08")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

c$valor_da <- 0
c$valor_da_inf_orgao <- 0

c <- c %>% 
  distinct()

d <- base_da1 %>%
  filter(str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44903900\\.08")) %>% 
  select(-distrito, -tipo_regionalizacao) 

e <- tibble(
  dotacao = rep(d$dotacao),
  sigla_orgao = rep(d$sigla_orgao),
  subprefeitura = rep(d$subprefeitura),
  regiao = rep(d$regiao),
  valor_detalhamento_acao = rep(d$valor_detalhamento_acao),
  orgao = unique(c$orgao),
  meta = rep(unique(c$meta)),
  txt_meta = rep(unique(c$txt_meta)),
  total_smae = rep(unique(c$total_smae))) 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44903900\\.08")) 

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44903900\\.08"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) 

rm(list = c("a", "b", "c", "d", "e"))	

#12 98.22.26.453.3009.5.105.44905100.08
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44905100\\.08") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor))

b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44905100\\.08")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44905100\\.08")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

c$valor_da <- 0
c$valor_da_inf_orgao <- 0

c <- c %>% 
  distinct()

d <- base_da1 %>%
  filter(str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44905100\\.08")) %>% 
  select(-distrito, -tipo_regionalizacao) 

e <- tibble(
  dotacao = rep(d$dotacao),
  sigla_orgao = rep(d$sigla_orgao),
  subprefeitura = rep(d$subprefeitura),
  regiao = rep(d$regiao),
  valor_detalhamento_acao = rep(d$valor_detalhamento_acao),
  orgao = unique(c$orgao),
  meta = rep(unique(c$meta)),
  txt_meta = rep(unique(c$txt_meta)),
  total_smae = rep(unique(c$total_smae))) 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44905100\\.08")) 

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^98\\.22\\.26\\.453\\.3009\\.5\\.105\\.44905100\\.08"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) 

rm(list = c("a", "b", "c", "d", "e"))	

#13 25.10.13.392.3001.6.371.3390
(a <- base_da1 %>% 
  filter(str_detect(dotacao, "^25\\.10\\.13\\.392\\.3001\\.6\\.371\\.3390") & valor_detalhamento_acao > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_detalhamento_acao = sum(valor_detalhamento_acao), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_detalhamento_acao),
         prop_dot = valor_detalhamento_acao / total_valor))

b <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^25\\.10\\.13\\.392\\.3001\\.6\\.371\\.3390")& !str_length(dotacao) < 48) #para obter um df com as dotações completas

c <- comp_sub_dot %>% 
  filter(str_detect(dotacao, "^25\\.10\\.13\\.392\\.3001\\.6\\.371\\.3390")& str_length(dotacao) < 48) #para obter um df com as informações sobre meta e total_smae

c$valor_da <- 0
c$valor_da_inf_orgao <- 0

c <- c %>% 
  distinct()

d <- base_da1 %>%
  filter(str_detect(dotacao, "^25\\.10\\.13\\.392\\.3001\\.6\\.371\\.3390")) %>% 
  select(-distrito, -tipo_regionalizacao) 

e <- tibble(
  dotacao = rep(d$dotacao),
  sigla_orgao = rep(d$sigla_orgao),
  subprefeitura = rep(d$subprefeitura),
  regiao = rep(d$regiao),
  valor_detalhamento_acao = rep(d$valor_detalhamento_acao),
  orgao = unique(c$orgao),
  meta = rep(unique(c$meta)),
  txt_meta = rep(unique(c$txt_meta)),
  total_smae = rep(unique(c$total_smae))) 

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(dotacao, "^25\\.10\\.13\\.392\\.3001\\.6\\.371\\.3390")) 

comp_sub_dot %>% 
  filter(str_detect(dotacao, "^25\\.10\\.13\\.392\\.3001\\.6\\.371\\.3390"))

comp_sub_dot <- comp_sub_dot %>% 
  bind_rows(e) 

rm(list = c("a", "b", "c", "d", "e"))

```

Ajustadas as dotações incompletas, avançaremos para o tratamento da distribuição dentre as subprefeituras dos valores liquidados em dotações Supra Regionais.

```{r}

# Retirar registros Supra Subprefeituras com valor detalhamento da ação nulo 
(a <- comp_sub_dot %>% 
  filter(str_detect(subprefeitura, "Supra") & valor_detalhamento_acao != 0))

comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(subprefeitura, "Supra")) %>% 
  bind_rows(a)

rm(a)

# Garantir que todas as dotações supra tenham as respectivas subs
b <- expand_grid(dotacao = unique(base_da1$dotacao),
                 subprefeitura = unique(base_da1$subprefeitura)) %>% 
  filter(!str_detect(subprefeitura, "Supra"))

comp_sub_dot <- comp_sub_dot %>% 
  left_join(b, by = intersect(names(b), names(comp_sub_dot))) %>% 
  distinct()

rm(b)

#juntar count e valor_rateio
comp_sub_dot <- comp_sub_dot %>% 
  left_join(suporte_rateio_regioes, by = intersect(names(comp_sub_dot), names(suporte_rateio_regioes))) %>% 
  distinct() %>% 
  replace_na(list(count = 0, valor_rateio = 0))

comp_sub_dot %>% 
  filter(dotacao == "04.10.15.452.3011.2.300.33903000.06.1.501.9001.0")

# acrescentar coluna somando valor_detalhamento_acao + valor_rateio
comp_sub_dot <- comp_sub_dot %>% 
  mutate(valor_liquidado = valor_detalhamento_acao + valor_rateio) %>% 
  replace_na(valor_liquidado = 0)

# remover linhas que contém "supra"
comp_sub_dot <- comp_sub_dot %>% 
  filter(!str_detect(subprefeitura, fixed("Supra")))

sum(comp_sub_dot$valor_liquidado) #32595730944
sum(base_da1$valor_detalhamento_acao) #32595730944

d <- comp_sub_dot %>% 
  group_by(dotacao) %>% 
  summarise(checagem = mean(total_smae))

sum(d$checagem)

# acrescentar o gasto proporcial em cada região; em cada dotação
comp_sub_dot <- comp_sub_dot %>% 
  group_by(dotacao) %>% 
  mutate(total_valor = sum(valor_liquidado))

comp_sub_dot <- comp_sub_dot %>% 
  mutate(proporcao = valor_liquidado/total_valor)




```



```{r}



comp_sub_dot %>% 
  filter(dotacao == "86.14.16.451.3002.3.357.44903900.03")

comp_sub_dot %>% 
  filter(str_length(dotacao) < 48)



# criar objeto "base_da2" apenas com colunas de interesse
base_da2 <- comp_sub_dot %>% 
  mutate(acao_orcamentaria = substr(dotacao, 19, 23)) %>%
  select(-tipo_regionalizacao, -count, -valor_rateio, -total_valor)

# criar df a partir de base_da2, base_da_pdm, apenas com as dotações do PdM - esta é a base que nos interessa, pois tem as dotações com valores de liquidação registradas no smae, as proporções do DA e a regionalização
nchar("84.10.10.301.3003.1.525.44905100.00.1.500.9001.1") #=48
nchar("25.10.13.392.3001.6.371.3390") #=28

base_dotacao_pdm <- unique(base_smae$dotacao) #string com as dotações pdm

base_dot_pdm <- tibble(
  dotacao = base_dotacao_pdm,
  acao_orcamentaria = substr(dotacao, 19, 23)) %>% 
  filter(!is.na(dotacao))

# trazer informação do valor liquidado registrado no smae e do valor_inf_orgao para acrescentar à base_dot_pdm
base_dot_pdm <- base_dot_pdm %>% 
  full_join(base_smae, by = "dotacao") %>% 
  distinct() %>% 
  filter(!is.na(total_smae))

base_dot_pdm <- base_dot_pdm %>% 
  full_join(base_inf_orgaos, by = c("meta", "dotacao", "subprefeitura")) %>% 
  distinct() %>% 
  replace_na(list(valor_da_inf_orgao = 0)) %>% 
  filter(!str_detect(subprefeitura, "Supra"))

rm(list = c("base_smae", "base_inf_orgaos"))

intersec_da2_dot_pdm <- dplyr::intersect(names(base_da2), names(base_dot_pdm)) #identificando colunas em comum

# Criar a base_da_pdm
base_da_pdm <- base_da2 %>% 
  right_join(base_dot_pdm, by = intersec_da2_dot_pdm) %>% 
  distinct()


# checar se todas as dotações somam 100%
a <- base_da_pdm %>% 
  group_by(meta, dotacao) %>% 
  summarise(checagem = sum(proporcao, na.rm = TRUE)) # Necessário tratar NA

a %>% 
  filter(checagem > 1)

#1 19.10.27.812.3017.3.512.44903900.00.1.500.9001.1	9			
base_da_pdm %>% 
  filter(dotacao == "19.10.27.812.3017.3.512.44903900.00.1.500.9001.1")

b <- base_da_pdm %>% 
  filter(dotacao == "19.10.27.812.3017.3.512.44903900.00.1.500.9001.1") %>% 
  distinct()

b <- b %>% 
  group_by(subprefeitura) %>% 
  distinct() %>% 
  filter(!is.na(sigla_orgao)) %>% 
  slice(1)
  
base_da_pdm <- base_da_pdm %>% 
  filter(dotacao != "19.10.27.812.3017.3.512.44903900.00.1.500.9001.1") %>% 
  bind_rows(b)

rm(list = c("a", "b"))

# ajustar dotacoes que não estão com a codificação completa 
base_da_pdm %>% 
  select(dotacao) %>% 
  filter(str_length(dotacao) < 48) %>% 
  distinct() #13 situações 


# acrescentar coluna total_inf_orgaos

#ler a aba totais_metas_inf_orgaos
x <- readxl::read_excel("metas_alteracao_programatica.xlsx", sheet = "totais_metas_inf_orgaos", skip = 266) %>% 
    dplyr::select(-c("Diferença Soma dos valores proporcionais vs SMAE", "Observações")) %>% 
    dplyr::rename("SE+SUPRACENTRO" = "SE+SUPRA_CENTRO") #para padronizar os nomes dessas colunas

#transformar as colunas de subprefeituras e supra subprefeituras em uma única coluna
(x <- x %>%
  tidyr::pivot_longer(
      cols = c("Subprefeitura Aricanduva/Formosa/Carrão":"SE+SUPRACENTRO"),
      names_to = "subprefeitura",
      values_to = "valor_da_inf_orgao") %>%
  janitor::clean_names() %>% 
    dplyr::select(orgao, meta, txt_meta, dotacao, subprefeitura, total_smae, valor_da_inf_orgao) %>% 
  filter(orgao %in% c("SMS", "SMC") & subprefeitura != "Subprefeitura Sé"))

x <- x %>% 
  mutate(subprefeitura = if_else(subprefeitura %in% "SE+SUPRACENTRO", "Subprefeitura Sé", subprefeitura)) %>% 
  filter(subprefeitura != "SE+SUPRACENTRO" & valor_da_inf_orgao != 0)

filter(x, str_length(dotacao) < 48)
#1 situação

#1 25.10.13.392.3001.6.371.3390
(a <- base_da2 %>% 
  filter(str_detect(dotacao, "^25\\.10\\.13\\.392\\.3001\\.6\\.371\\.3390") & valor_liquidado > 0) %>% 
  group_by(dotacao) %>% 
  summarise(valor_liquidado = sum(valor_liquidado), .groups = "drop") %>% 
  mutate(total_valor = sum(valor_liquidado),
         prop = valor_liquidado / total_valor))

(b <- base_da_pdm %>% 
  filter(str_detect(dotacao, "^25\\.10\\.13\\.392\\.3001\\.6\\.371\\.3390")))

c <- base_da2 %>% 
  filter(dotacao %in% a$dotacao)

(d <- tibble(dotacao = rep(a$dotacao, each = 32),
                       prop = rep(a$prop, each = 32),
                       acao_orcamentaria = rep(b$acao_orcamentaria, 2),
                       orgao = rep(b$orgao, 2),
                       meta = rep(b$meta, 2),
                       txt_meta = rep(b$txt_meta, 2),
                       total_smae.x = rep(b$total_smae, 2),
                       total_smae.y = total_smae.x * prop))

d <- d %>% 
  rename(total_smae = total_smae.y) %>% 
  select(-total_smae.x, - prop)

d <- d %>% 
  left_join(c, by = c("dotacao", "acao_orcamentaria")) %>% 
  distinct() %>% 
  select(dotacao, sigla_orgao, subprefeitura, regiao, valor_detalhamento_acao, valor_liquidado, proporcao, acao_orcamentaria, orgao, meta, txt_meta, total_smae)

base_da_pdm <- base_da_pdm %>% 
  filter(!str_detect(dotacao, "^25\\.10\\.13\\.392\\.3001\\.6\\.371\\.3390")) %>%
  bind_rows(d)

rm(list = c("a", "b", "c",  "d"))

# Trazer informações do total_inf_orgao
readxl::excel_sheets("metas_alteracao_programatica.xlsx")


# acrescentar valor de exec_fisica
url_balanco <- "https://www.prefeitura.sp.gov.br/cidade/secretarias/upload/governo/planejamento/Relat%C3%B3rio%20de%20Execu%C3%A7%C3%A3o%20Anual%20do%20Programa%20de%20Metas%202021-2024%20(Abril2024).xlsx" #note que o documento é de abril. Caso o documento seja atualizado, necessário alterar o link

response <- httr::GET(url_balanco) # Fazendo a solicitação GET

content <- httr::content(response, as = "raw") # Extraindo o conteúdo da resposta como um objeto raw

temp_file <- tempfile(fileext = ".xlsx") # Criando um arquivo temporário para armazenar o conteúdo

writeBin(content, temp_file) # Escrevendo o conteúdo no arquivo temporário

(base_exec_fisica <- readxl::read_excel(temp_file, sheet = "principal", skip = 2) %>% 
    janitor::clean_names())

(base_exec_fisica <- base_exec_fisica %>% 
  rename(meta = x1,
         txt_meta = x2,
         indicador = x3,
         objetivo_estrategico = x4,
         iniciativas = x5,
         eixo = x6,
         ods = x7,
         orgao = x8)) #necessário ajustar o padrão de pontuação (ora milhares está separado por "." ora por "," ora está sem separação)


(base_exec_fisica_reg <- readxl::read_excel(temp_file, sheet = "regionalização", skip = 1) %>% 
    janitor::clean_names())

(base_exec_fisica_reg <- base_exec_fisica_reg %>% 
  rename(meta = x1,
         subprefeitura = x2)) # necessário padronizar nomes das subprefeituras conforme base_pdm_completa e preencher coluna meta, cujas células estão mescladas na planilha original


# Padronizar nome das subprefeituras conforme base_pdm_completa
(base_exec_fisica_reg <- base_exec_fisica_reg %>% 
  mutate(subprefeitura = case_when(
           subprefeitura %in% "Aricanduva" ~ "Subprefeitura Aricanduva/Formosa/Carrão",
           subprefeitura %in% "Butantã" ~ "Subprefeitura Butantã",
           subprefeitura %in% "Campo Limpo" ~ "Subprefeitura Campo Limpo",
           subprefeitura %in% "Capela do Socorro" ~ "Subprefeitura Capela do Socorro",
           subprefeitura %in% "Casa Verde" ~ "Subprefeitura Casa Verde/Cachoeirinha",
           subprefeitura %in% "Cidade Ademar" ~ "Subprefeitura Cidade Ademar",
           subprefeitura %in% "Cidade Tiradentes" ~ "Subprefeitura Cidade Tiradentes",
           subprefeitura %in% "Ermelino Matarazzo" ~ "Subprefeitura Ermelino Matarazzo",
           subprefeitura %in% "Freguesia/Brasilândia" ~ "Subprefeitura Ermelino Matarazzo",
           subprefeitura %in% "Guaianases" ~ "Subprefeitura de Guaianases",
           subprefeitura %in% "Ipiranga" ~ "Subprefeitura Ipiranga",
           subprefeitura %in% "Itaim Paulista" ~ "Subprefeitura Ipiranga",
           subprefeitura %in% "Itaquera" ~ "Subprefeitura Itaquera",
           subprefeitura %in% "Jabaquara" ~ "Subprefeitura Itaquera",
           subprefeitura %in% "Jaçanã/Tremembé" ~ "Subprefeitura Jaçanã/Tremembé",
           subprefeitura %in% "Lapa" ~ "Subprefeitura Lapa",
           subprefeitura %in% "M'Boi Mirim" ~ "Subprefeitura M'Boi Mirim",
           subprefeitura %in% "Mooca" ~ "Subprefeitura Mooca",
           subprefeitura %in% "Parelheiros" ~ "Subprefeitura Parelheiros",
           subprefeitura %in% "Penha" ~ "Subprefeitura Penha",
           subprefeitura %in% "Perus/Anhanguera" ~ "Subprefeitura Perus/Anhanguera",
           subprefeitura %in% "Pinheiros" ~ "Subprefeitura Pinheiros",
           subprefeitura %in% "Pirituba/Jaraguá" ~ "Subprefeitura Pirituba/Jaraguá",
           subprefeitura %in% "Santana/Tucuruvi" ~ "Subprefeitura Santana/Tucuruvi",
           subprefeitura %in% "Santo Amaro" ~ "Subprefeitura Santo Amaro",
           subprefeitura %in% "São Mateus" ~ "Subprefeitura São Mateus",
           subprefeitura %in% "São Miguel Paulista" ~ "Subprefeitura São Miguel Paulista",
           subprefeitura %in% "Sapopemba" ~ "Subprefeitura Sapopemba",
           subprefeitura %in% "Sé" ~ "Subprefeitura Sé",
           subprefeitura %in% "Vila Maria/Vila Guilherme" ~ "Subprefeitura Vila Maria/Vila Guilherme",
           subprefeitura %in% "Vila Mariana" ~ "Subprefeitura Vila Mariana",
           TRUE ~ "Subprefeitura de Vila Prudente")))

# Substituir NA na coluna meta
(base_exec_fisica_reg <- base_exec_fisica_reg %>% 
  fill(meta, .direction = "down"))

# Selecionar apenas as colunas meta, subprefeitura e x2023
(base_exec_fisica_reg_23 <- base_exec_fisica_reg %>% 
  select(meta, subprefeitura, x2023))

# Juntar com base_pdm_completa
(a <- base_pdm_completa %>% 
  left_join(base_exec_fisica_reg_23, by = c("meta", "subprefeitura")) %>% 
    distinct())

glimpse(base_exec_fisica_reg_23)
glimpse(base_pdm_completa)

b <- base_pdm_completa %>% 
  group_by(meta, dotacao) %>% 
  summarise(valor_da = sum(valor_liquidado),
            valor_smae = mean(total_smae),
            valor_inf_orgao = sum(valor_da_inf_orgao))

sum(b$valor_smae, na.rm = TRUE)

(c <- base_pdm_completa %>% 
  filter(dotacao %in% d) %>% 
  arrange(meta, dotacao) %>% 
  select(meta, dotacao, subprefeitura, valor_liquidado, total_smae, valor_da_inf_orgao))

e <- base_pdm_completa %>% 
  group_by(dotacao) %>% 
  arrange(dotacao, meta) %>% 
  fill(meta, .direction = "down")

?fill()

c %>% 
  filter(dotacao == "07.10.16.482.3002.3.340.44906100.08.2.759.1224.1")


d <- c$dotacao

a %>% 
  filter(meta == 3)

# acrescentar coluna de estimativa (total_liquidado / exec_fisica)
```

